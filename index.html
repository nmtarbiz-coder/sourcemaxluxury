<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DialTrader ‚Äî Watch Trading Desk</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2MDAgNzAwIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPgogIDxkZWZzPgogICAgPHJhZGlhbEdyYWRpZW50IGlkPSJmY2dvbGQiIGN4PSI1MCUiIGN5PSI0NSUiIHI9IjY1JSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNGRkYzQjUiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIzMCUiIHN0b3AtY29sb3I9IiNFNUMxNUEiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSI2NSUiIHN0b3AtY29sb3I9IiNDODlFMkYiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjOEE2QTFGIi8+CiAgICA8L3JhZGlhbEdyYWRpZW50PgogICAgPGxpbmVhckdyYWRpZW50IGlkPSJmY2VkZ2UiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI0ZGRjZDQyIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjUwJSIgc3RvcC1jb2xvcj0iI0Q0QTYzQSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM3QTVBMTgiLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSI2MDAiIGhlaWdodD0iNzAwIiBmaWxsPSIjMEEwQTBBIi8+CiAgPGNpcmNsZSBjeD0iMzAwIiBjeT0iMzMwIiByPSIyMTAiIGZpbGw9Im5vbmUiIHN0cm9rZT0idXJsKCNmY2dvbGQpIiBzdHJva2Utd2lkdGg9IjUwIi8+CiAgPGNpcmNsZSBjeD0iMzAwIiBjeT0iMzMwIiByPSIxODAiIGZpbGw9Im5vbmUiIHN0cm9rZT0idXJsKCNmY2VkZ2UpIiBzdHJva2Utd2lkdGg9IjMiIG9wYWNpdHk9IjAuNyIvPgogIDxjaXJjbGUgY3g9IjMwMCIgY3k9IjMzMCIgcj0iMTYwIiBmaWxsPSIjMEUwRTBFIiBzdHJva2U9InVybCgjZmNlZGdlKSIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPGcgc3Ryb2tlPSJ1cmwoI2ZjZWRnZSkiIHN0cm9rZS13aWR0aD0iNiI+CiAgICA8bGluZSB4MT0iMzAwIiB5MT0iMTYwIiB4Mj0iMzAwIiB5Mj0iMTkwIi8+CiAgICA8bGluZSB4MT0iMzAwIiB5MT0iNDcwIiB4Mj0iMzAwIiB5Mj0iNTAwIi8+CiAgICA8bGluZSB4MT0iMTMwIiB5MT0iMzMwIiB4Mj0iMTYwIiB5Mj0iMzMwIi8+CiAgICA8bGluZSB4MT0iNDQwIiB5MT0iMzMwIiB4Mj0iNDcwIiB5Mj0iMzMwIi8+CiAgPC9nPgogIDxnIHN0cm9rZT0idXJsKCNmY2VkZ2UpIiBzdHJva2UtbGluZWNhcD0icm91bmQiPgogICAgPGxpbmUgeDE9IjMwMCIgeTE9IjMzMCIgeDI9IjI1MCIgeTI9IjI2MCIgc3Ryb2tlLXdpZHRoPSIxMCIvPgogICAgPGxpbmUgeDE9IjMwMCIgeTE9IjMzMCIgeDI9IjM4MCIgeTI9IjI1MCIgc3Ryb2tlLXdpZHRoPSI2Ii8+CiAgPC9nPgogIDxjaXJjbGUgY3g9IjMwMCIgY3k9IjMzMCIgcj0iMTAiIGZpbGw9InVybCgjZmNlZGdlKSIvPgo8L3N2Zz4=">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,700;1,400;1,500&family=Raleway:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script>
   const BIZ_NAME     = 'Source Max Luxury';
  const BIZ_ADDRESS  = 'Conway, Arkansas';
  const BIZ_EMAIL    = 'toxictimers@gmail.com';
  const BIZ_PHONE    = '(501) 237-6481';
  const PAY_ZELLE    = '(501) 733-1970';
  const PAY_APPLEPAY = '(501) 7331970-0000';
  const WIRE_BANK    = 'Centennial Bank';
  const WIRE_NAME    = 'Nathan Tolliver - NXT Enterprises LLC';
  const WIRE_ADDRESS = '345 Nob Hill St Conway AR 72034';
  const WIRE_ACCOUNT = '502483711';
  const WIRE_ROUTING = '082902757';
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#F5F2ED;--surface:#FFFFFF;--surface2:#EEEBE5;--border:#DDD8D0;--border2:#CCC8C0;
  --text:#1A1A1A;--text2:#7A756E;--gold:#B8943A;--gold2:#D4AF5A;--gold-dim:rgba(184,148,58,0.12);
  --green:#3A7A5A;--green-dim:rgba(58,122,90,0.1);--red:#B03A3A;--red-dim:rgba(176,58,58,0.1);
  --blue:#3A6A9A;--blue-dim:rgba(58,106,154,0.1);--charcoal:#2A2A2A;--sidebar-w:210px;
}
html,body{height:100%;}
body{font-family:'Raleway',sans-serif;background:var(--bg);color:var(--text);overflow:hidden;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
@keyframes spin{to{transform:rotate(360deg);}}
@keyframes load{to{left:110%;}}

/* LOADING */
#loading-screen{display:none;position:fixed;inset:0;background:var(--charcoal);align-items:center;justify-content:center;flex-direction:column;gap:1.25rem;z-index:9999;}
#loading-screen.visible{display:flex;}
.loading-logo{font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:500;letter-spacing:0.15em;color:#C9A84C;text-transform:uppercase;}
.loading-logo span{font-style:italic;color:#fff;}
.loading-bar{width:140px;height:1px;background:#444;position:relative;overflow:hidden;}
.loading-bar::after{content:'';position:absolute;left:-60%;top:0;width:60%;height:100%;background:#C9A84C;animation:load 1.2s ease infinite;}

/* AUTH */
#auth-screen{display:none;min-height:100vh;align-items:center;justify-content:center;background:var(--charcoal);}
#auth-screen.visible{display:flex;}
.auth-box{width:420px;max-width:95vw;background:#fff;border:1px solid var(--border2);padding:2.5rem;box-shadow:0 8px 40px rgba(0,0,0,0.2);}
.auth-logo{font-family:'Playfair Display',serif;font-size:2rem;font-weight:500;letter-spacing:0.15em;color:var(--charcoal);text-transform:uppercase;text-align:center;margin-bottom:0.25rem;}
.auth-logo em{font-style:italic;color:var(--gold);}
.auth-tagline{text-align:center;font-size:0.62rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--text2);margin-bottom:2rem;}
.auth-tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:1.5rem;}
.auth-tab{flex:1;text-align:center;padding:0.6rem;font-size:0.68rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.15s;font-weight:600;}
.auth-tab.active{color:var(--gold);border-bottom-color:var(--gold);}
.auth-form{display:none;}.auth-form.active{display:block;}
.auth-label{display:block;font-size:0.6rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--text2);margin-bottom:0.4rem;font-weight:600;}
.auth-input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:0.7rem 0.85rem;font-family:'Raleway',sans-serif;font-size:0.82rem;outline:none;margin-bottom:1rem;transition:border-color 0.15s;}
.auth-input:focus{border-color:var(--gold);}
.auth-btn{width:100%;background:var(--charcoal);color:#fff;border:none;padding:0.75rem;font-family:'Raleway',sans-serif;font-size:0.75rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;cursor:pointer;transition:background 0.15s;margin-top:0.5rem;}
.auth-btn:hover{background:#444;}.auth-btn:disabled{opacity:0.5;cursor:not-allowed;}
.auth-error{font-size:0.7rem;color:var(--red);margin-top:0.75rem;text-align:center;min-height:1.2rem;}
.auth-success{font-size:0.7rem;color:var(--green);margin-top:0.75rem;text-align:center;}

/* APP LAYOUT */
#app-screen{display:none;height:100vh;}
#app-screen.visible{display:flex;}

/* SIDEBAR */
.sidebar{width:var(--sidebar-w);flex-shrink:0;background:var(--charcoal);display:flex;flex-direction:column;height:100vh;overflow-y:auto;border-right:3px solid var(--gold);}
.sidebar-logo{padding:1rem 0.75rem 0.75rem;border-bottom:1px solid #3A3A3A;text-align:center;}
.sidebar-logo-text{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:500;letter-spacing:0.1em;color:#fff;text-transform:uppercase;}
.sidebar-logo-text em{font-style:italic;color:var(--gold2);}
.sidebar-logo-sub{font-size:0.68rem;letter-spacing:0.18em;text-transform:uppercase;color:#999;margin-top:0.3rem;font-weight:500;}
.sidebar-section-label{font-size:0.52rem;letter-spacing:0.22em;text-transform:uppercase;color:#555;padding:1rem 1.25rem 0.4rem;font-weight:700;}
.nav-item{display:flex;align-items:center;gap:0.7rem;padding:0.65rem 1.25rem;font-size:0.75rem;font-weight:500;letter-spacing:0.04em;color:#AAA;cursor:pointer;transition:all 0.15s;border-left:3px solid transparent;margin-left:-3px;}
.nav-item:hover{color:#fff;background:rgba(255,255,255,0.05);}
.nav-item.active{color:#fff;background:rgba(184,148,58,0.15);border-left-color:var(--gold2);}
.nav-icon{font-size:1rem;width:1.2rem;text-align:center;flex-shrink:0;}
.nav-badge{margin-left:auto;background:var(--gold);color:#fff;font-size:0.55rem;font-weight:700;padding:0.1rem 0.4rem;border-radius:2px;}
.sidebar-footer{margin-top:auto;padding:1rem 1.25rem;border-top:1px solid #3A3A3A;}
.sidebar-user{font-size:0.65rem;color:#666;margin-bottom:0.6rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.sidebar-signout{font-size:0.65rem;color:#888;cursor:pointer;letter-spacing:0.06em;text-transform:uppercase;}
.sidebar-signout:hover{color:var(--red);}

/* MAIN */
.main-content{flex:1;overflow-y:auto;height:100vh;}
.page{display:none;padding:2rem;animation:fadeIn 0.25s ease;}
.page.active{display:block;}

/* BUTTONS */
.btn-gold{background:var(--gold);color:#fff;border:none;padding:0.5rem 1.2rem;font-family:'Raleway',sans-serif;font-size:0.7rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:background 0.15s;}
.btn-gold:hover{background:var(--gold2);}
.btn-outline{background:none;color:var(--text2);border:1px solid var(--border2);padding:0.5rem 1rem;font-family:'Raleway',sans-serif;font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:all 0.15s;}
.btn-outline:hover{color:var(--text);border-color:var(--text2);}
.btn-dark{background:var(--charcoal);color:#fff;border:none;padding:0.5rem 1.2rem;font-family:'Raleway',sans-serif;font-size:0.7rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;}
.btn-dark:hover{background:#444;}
.btn-danger{background:none;border:1px solid var(--red);color:var(--red);padding:0.5rem 1rem;font-family:'Raleway',sans-serif;font-size:0.7rem;letter-spacing:0.08em;cursor:pointer;transition:all 0.15s;}
.btn-danger:hover{background:var(--red-dim);}
.btn-sm{padding:0.3rem 0.75rem;font-size:0.62rem;}

/* PAGE HEADER */
.page-header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:0.75rem;}
.page-title{font-family:'Playfair Display',serif;font-size:2rem;font-weight:400;}
.page-title span{color:var(--gold);font-style:italic;}
.page-subtitle{font-size:0.72rem;color:var(--text2);margin-top:0.25rem;}

/* DASHBOARD */
.dash-hero{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);border:1px solid var(--border);margin-bottom:2rem;}
@media(max-width:900px){.dash-hero{grid-template-columns:repeat(2,1fr);}}
.hero-stat{background:var(--surface);padding:1.5rem;position:relative;overflow:hidden;}
.hero-stat::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--gold);transform:scaleX(0);transform-origin:left;transition:transform 0.6s cubic-bezier(0.4,0,0.2,1);}
.hero-stat.loaded::after{transform:scaleX(1);}
.hero-label{font-size:0.6rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--text2);margin-bottom:0.6rem;font-weight:600;}
.hero-value{font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:400;line-height:1;margin-bottom:0.3rem;}
.hero-value.green{color:var(--green);}.hero-value.gold{color:var(--gold);}.hero-value.red{color:var(--red);}
.hero-sub{font-size:0.62rem;color:var(--text2);}
.dash-grid{display:grid;grid-template-columns:1fr 300px;gap:1.5rem;}
@media(max-width:900px){.dash-grid{grid-template-columns:1fr;}}
.panel{background:var(--surface);border:1px solid var(--border);padding:1.5rem;}
.panel-title{font-size:0.62rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--gold);margin-bottom:1.25rem;padding-bottom:0.75rem;border-bottom:1px solid var(--border);font-weight:600;}
.mini-table{width:100%;border-collapse:collapse;}
.mini-table th{font-size:0.58rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--text2);text-align:left;padding:0 0.75rem 0.75rem;border-bottom:1px solid var(--border);font-weight:600;}
.mini-table td{padding:0.75rem;font-size:0.75rem;border-bottom:1px solid var(--border);vertical-align:middle;}
.mini-table tr:last-child td{border-bottom:none;}
.mini-table tr:hover td{background:var(--surface2);}
.brand-badge{font-size:0.6rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--gold);background:var(--gold-dim);padding:0.15rem 0.5rem;display:inline-block;}
.days-pill{font-size:0.65rem;padding:0.15rem 0.5rem;background:var(--surface2);color:var(--text2);}
.days-pill.warn{background:rgba(176,58,58,0.15);color:var(--red);}
.days-pill.ok{background:var(--green-dim);color:var(--green);}
.brand-row{display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;}
.brand-name{font-size:0.72rem;min-width:80px;color:var(--text2);}
.brand-bar-wrap{flex:1;height:4px;background:var(--border);}
.brand-bar{height:100%;background:var(--gold);transition:width 0.8s cubic-bezier(0.4,0,0.2,1);}
.brand-profit{font-size:0.7rem;color:var(--green);min-width:70px;text-align:right;}

/* FILTER BAR */
.filter-bar{display:flex;gap:0.5rem;margin-bottom:1.5rem;align-items:center;flex-wrap:wrap;}
.search-input{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:0.5rem 0.85rem;font-family:'Raleway',sans-serif;font-size:0.75rem;outline:none;width:260px;transition:border-color 0.15s;}
.search-input::placeholder{color:var(--text2);}.search-input:focus{border-color:var(--gold);}
.filter-select{background:var(--surface);border:1px solid var(--border);color:var(--text2);padding:0.5rem 0.75rem;font-family:'Raleway',sans-serif;font-size:0.72rem;outline:none;cursor:pointer;}

/* INVENTORY */
.inv-rows{border:1px solid var(--border);background:var(--border);display:flex;flex-direction:column;gap:1px;}
.inv-row-header{display:grid;grid-template-columns:2.4fr 1fr 1fr 1fr 1fr 0.8fr 1fr;padding:0.5rem 1.25rem;background:var(--bg);gap:1rem;border-bottom:1px solid var(--border);}
.inv-row-header span{font-size:0.6rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--text2);font-weight:600;}
.inv-row{display:grid;grid-template-columns:2.4fr 1fr 1fr 1fr 1fr 0.8fr 1fr;align-items:center;padding:0.9rem 1.25rem;background:var(--surface);gap:1rem;cursor:pointer;transition:background 0.15s;}
.inv-row:hover{background:#EDE8E0;}
.inv-row:nth-child(even){background:var(--surface2);}
.inv-row:nth-child(even):hover{background:#E5E0D8;}
.inv-row-brand{font-size:0.64rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--gold);margin-bottom:0.25rem;font-weight:600;}
.inv-row-model{font-family:'Playfair Display',serif;font-size:1.1rem;line-height:1.25;color:var(--text);margin-bottom:0.2rem;}
.inv-row-sub{font-size:0.7rem;color:var(--text2);}
.inv-row-val{font-size:0.9rem;color:var(--text);}
.inv-row-val.gold{color:var(--gold);}.inv-row-val.green{color:var(--green);}.inv-row-val.red{color:var(--red);}.inv-row-val.muted{color:var(--text2);font-size:0.82rem;}

/* SOLD TABLE */
.sold-table{width:100%;border-collapse:collapse;}
.sold-table th{font-size:0.58rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--text2);text-align:left;padding:0.6rem 0.75rem;border-bottom:2px solid var(--border);white-space:nowrap;cursor:pointer;font-weight:600;background:var(--bg);}
.sold-table th:hover{color:var(--gold);}
.sold-table td{padding:0.8rem 0.75rem;font-size:0.74rem;border-bottom:1px solid var(--border);vertical-align:middle;}
.sold-table tr{cursor:pointer;}.sold-table tr:hover td{background:var(--surface2);}
.profit-badge{display:inline-block;padding:0.15rem 0.5rem;font-size:0.68rem;font-weight:700;}
.profit-badge.pos{background:var(--green-dim);color:var(--green);}
.profit-badge.neg{background:var(--red-dim);color:var(--red);}

/* CONTACTS */
.contacts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;}
.contact-card-item{background:var(--surface);border:1px solid var(--border);padding:1.25rem;cursor:pointer;transition:all 0.15s;display:flex;flex-direction:column;gap:0.5rem;}
.contact-card-item:hover{box-shadow:0 4px 20px rgba(0,0,0,0.08);transform:translateY(-2px);border-color:var(--gold);}
.contact-card-name{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:400;}
.contact-card-info{font-size:0.72rem;color:var(--text2);line-height:1.6;}
.contact-card-stats{display:flex;gap:0.75rem;margin-top:0.25rem;padding-top:0.75rem;border-top:1px solid var(--border);}
.contact-stat{text-align:center;}
.contact-stat-val{font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--gold);}
.contact-stat-label{font-size:0.55rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text2);}
.contact-tag{display:inline-block;font-size:0.55rem;letter-spacing:0.1em;text-transform:uppercase;padding:0.15rem 0.5rem;margin-right:0.25rem;}
.contact-tag.buyer{background:var(--blue-dim);color:var(--blue);}
.contact-tag.seller{background:var(--green-dim);color:var(--green);}
.contact-tag.both{background:var(--gold-dim);color:var(--gold);}
.contact-history-item{display:flex;align-items:center;justify-content:space-between;padding:0.85rem 1rem;background:var(--surface);border:1px solid var(--border);margin-bottom:0.5rem;gap:1rem;}
.contact-history-type{font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;padding:0.2rem 0.5rem;}
.contact-history-type.bought{background:var(--green-dim);color:var(--green);}
.contact-history-type.sold-to{background:var(--blue-dim);color:var(--blue);}

/* INVOICES LIST */
.invoice-list{display:flex;flex-direction:column;gap:0.75rem;}
.invoice-item{background:var(--surface);border:1px solid var(--border);padding:1rem 1.25rem;display:grid;grid-template-columns:90px 1fr auto auto auto;align-items:center;gap:1rem;cursor:pointer;transition:background 0.15s;}
.invoice-item:hover{background:var(--surface2);border-color:var(--gold);}
.invoice-num{font-family:'Playfair Display',serif;font-size:1rem;color:var(--gold);}
.invoice-client{font-size:0.85rem;font-weight:500;}
.invoice-desc{font-size:0.7rem;color:var(--text2);}
.invoice-amount{font-family:'Playfair Display',serif;font-size:1.1rem;text-align:right;}
.invoice-status{font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;padding:0.2rem 0.6rem;}
.invoice-status.paid{background:var(--green-dim);color:var(--green);}
.invoice-status.unpaid{background:var(--red-dim);color:var(--red);}
.invoice-status.partial{background:var(--gold-dim);color:var(--gold);}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:500;align-items:center;justify-content:center;padding:1rem;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border2);width:600px;max-width:100%;max-height:92vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.15);}
.modal-lg{width:860px;}
.modal-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--charcoal);}
.modal-title{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:400;color:#fff;}
.modal-close{background:none;border:none;color:#888;font-size:1.2rem;cursor:pointer;line-height:1;padding:0.25rem;}
.modal-close:hover{color:#fff;}
.modal-body{padding:1.5rem;}
.modal-footer{padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:0.75rem;background:var(--bg);}
.modal-actions{display:flex;gap:0.5rem;}
.modal-tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:1.25rem;overflow-x:auto;}
.modal-tab{padding:0.6rem 1rem;font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.15s;white-space:nowrap;font-family:'Raleway',sans-serif;font-weight:600;}
.modal-tab:hover{color:var(--text);}.modal-tab.active{color:var(--gold);border-bottom-color:var(--gold);}
.modal-tab-panel{display:none;}.modal-tab-panel.active{display:block;}

/* FORMS */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
.form-group{margin-bottom:0;}.form-group.full{grid-column:1/-1;}
.form-label{display:block;font-size:0.6rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--text2);margin-bottom:0.4rem;font-weight:600;}
.form-input,.form-select,.form-textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:0.6rem 0.75rem;font-family:'Raleway',sans-serif;font-size:0.78rem;outline:none;transition:border-color 0.15s;}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--gold);}
.form-textarea{resize:vertical;min-height:70px;}
.section-divider{font-size:0.6rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--text2);margin:0.75rem 0;display:flex;align-items:center;gap:0.75rem;}
.section-divider::before,.section-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.contact-card-form{background:var(--bg);border:1px solid var(--border);padding:1rem;margin-bottom:0.75rem;}
.contact-card-form-title{font-size:0.6rem;letter-spacing:0.16em;text-transform:uppercase;color:var(--gold);margin-bottom:0.75rem;font-weight:600;}
.color-row{display:flex;gap:0.4rem;flex-wrap:wrap;margin-top:0.4rem;}
.color-chip{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:border-color 0.1s,transform 0.1s;flex-shrink:0;}
.color-chip:hover{transform:scale(1.15);}.color-chip.selected{border-color:var(--gold)!important;}
.platform-checks{display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.4rem;}
.platform-check{display:flex;align-items:center;gap:0.3rem;background:var(--surface2);border:1px solid var(--border);padding:0.25rem 0.6rem;cursor:pointer;font-size:0.7rem;transition:all 0.12s;user-select:none;position:relative;}
.platform-check:hover{border-color:var(--gold);}
.platform-check.selected{background:var(--gold-dim);border-color:var(--gold);color:var(--gold);font-weight:600;}
.platform-check input{position:absolute;opacity:0;width:0;height:0;}
/* STAGE BADGES */
.stage-badge{display:inline-flex;align-items:center;gap:0.3rem;font-size:0.58rem;letter-spacing:0.08em;text-transform:uppercase;padding:0.2rem 0.55rem;font-weight:700;white-space:nowrap;border-radius:2px;}
.stage-0{background:#2a2a2a;color:#888;}           /* Purchased - awaiting payment */
.stage-1{background:#1e3a5f;color:#6aabff;}        /* Paid - shipping to me */
.stage-2{background:#2d1f4a;color:#b48fff;}        /* In hand - cleaning */
.stage-3{background:#3a2200;color:#ffad33;}        /* Photography / prep */
.stage-4{background:#0a3a2a;color:#3fc88a;}        /* Listed - active */
.stage-5{background:#3a1a00;color:#ff8c42;}        /* Offer accepted */
.stage-6{background:#3a0a1a;color:#ff6b9d;}        /* Authentication */
.stage-7{background:#1a1a3a;color:#7eb3ff;}        /* Awaiting payment */
.stage-8{background:#003a2a;color:#4dffb4;}        /* Shipped to buyer */
.stage-9{background:#1a3a00;color:#90ff60;}        /* Closed / Complete */
.stage-dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
/* Stage selector in modal */
.stage-selector{display:flex;flex-direction:column;gap:0.35rem;margin-top:0.4rem;}
.stage-option{display:flex;align-items:center;gap:0.75rem;padding:0.5rem 0.75rem;border:1px solid var(--border);cursor:pointer;transition:all 0.12s;font-size:0.74rem;}
.stage-option:hover{border-color:var(--gold);background:var(--gold-dim);}
.stage-option.selected{border-color:var(--gold);background:var(--gold-dim);}
.stage-option-num{font-size:0.6rem;color:var(--text2);min-width:1.2rem;}
.tax-year-block{background:var(--surface);border:1px solid var(--border);margin-bottom:1.5rem;}
.tax-year-header{background:var(--charcoal);color:#fff;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;}
.tax-year-title{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:400;}
.tax-year-net{font-family:'Playfair Display',serif;font-size:1.5rem;}
.tax-year-net.pos{color:#7fca9f;}.tax-year-net.neg{color:#e8897a;}
.tax-summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);}
.tax-summary-cell{background:var(--surface);padding:1rem 1.5rem;}
.tax-summary-label{font-size:0.6rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--text2);margin-bottom:0.35rem;font-weight:600;}
.tax-summary-val{font-family:'Playfair Display',serif;font-size:1.3rem;}
.tax-transactions{padding:1.5rem;}
.tax-transactions table{width:100%;border-collapse:collapse;font-size:0.74rem;}
.tax-transactions th{font-size:0.58rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text2);padding:0.5rem 0.75rem;border-bottom:1px solid var(--border);text-align:left;}
.tax-transactions td{padding:0.65rem 0.75rem;border-bottom:1px solid var(--border);}
.photo-thumb img{width:100%;height:100%;object-fit:cover;display:block;}
.photo-thumb .photo-remove{position:absolute;top:3px;right:3px;background:rgba(0,0,0,0.6);color:#fff;border:none;width:20px;height:20px;border-radius:50%;font-size:0.65rem;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.photo-thumb .photo-main-badge{position:absolute;bottom:3px;left:3px;background:var(--gold);color:#fff;font-size:0.5rem;letter-spacing:0.08em;text-transform:uppercase;padding:0.1rem 0.3rem;}

/* IMPORT */
.import-zone{border:2px dashed var(--border2);padding:3rem;text-align:center;transition:border-color 0.2s;cursor:pointer;margin-bottom:1rem;}
.import-zone:hover,.import-zone.drag{border-color:var(--gold);}
.import-zone-icon{font-size:2.5rem;margin-bottom:1rem;opacity:0.4;}
.import-zone-title{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--text2);margin-bottom:0.5rem;}
.import-zone-sub{font-size:0.72rem;color:var(--text2);line-height:1.6;}
.import-instructions{background:var(--surface);border:1px solid var(--border);padding:1.5rem;margin-bottom:1.5rem;}
.import-instructions h3{font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--gold);margin-bottom:0.75rem;font-weight:500;}
.import-instructions p{font-size:0.75rem;color:var(--text2);line-height:1.7;}
.import-instructions code{background:var(--bg);padding:0.1rem 0.4rem;color:var(--gold);font-size:0.7rem;border:1px solid var(--border);}

/* INVOICE PREVIEW */
.invoice-preview{background:#fff;padding:2.5rem;font-family:'Raleway',sans-serif;border:1px solid var(--border);max-width:800px;margin:0 auto;}
.inv-hdr{display:grid;grid-template-columns:1fr auto 1fr;gap:1.5rem;align-items:start;margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:2px solid #e0e0e0;}
.inv-biz-name{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:#1A1A1A;margin-bottom:0.4rem;}
.inv-biz-info{font-size:0.75rem;color:#555;line-height:1.8;}
.inv-logo-area{text-align:center;display:flex;align-items:center;justify-content:center;}
.inv-logo-placeholder{font-size:2.5rem;opacity:0.3;}
.inv-title-block{text-align:right;}
.inv-title{font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:400;color:#1A1A1A;margin-bottom:0.75rem;}
.inv-meta-row{font-size:0.78rem;color:#555;display:flex;justify-content:flex-end;gap:1rem;margin-bottom:0.2rem;}
.inv-meta-row strong{color:#1A1A1A;min-width:80px;text-align:right;display:inline-block;}
.inv-bill-section{margin-bottom:2rem;padding:1.25rem;background:#f9f9f9;border-left:3px solid #2A2A2A;}
.inv-bill-label{font-size:0.6rem;letter-spacing:0.18em;text-transform:uppercase;color:#888;margin-bottom:0.5rem;font-weight:700;}
.inv-bill-name{font-size:1rem;font-weight:600;color:#1A1A1A;margin-bottom:0.25rem;}
.inv-bill-info{font-size:0.78rem;color:#555;line-height:1.7;}
.inv-table{width:100%;border-collapse:collapse;margin-bottom:1.5rem;}
.inv-table th{background:#2A2A2A;color:#fff;font-size:0.65rem;letter-spacing:0.14em;text-transform:uppercase;padding:0.65rem 1rem;text-align:left;font-weight:600;}
.inv-table th.right{text-align:right;}
.inv-table td{padding:1rem;font-size:0.82rem;border-bottom:1px solid #f0f0f0;vertical-align:top;}
.inv-table td.right{text-align:right;}
.inv-table .non-tax{font-size:0.65rem;color:#aaa;display:block;margin-top:0.2rem;}
.inv-bottom{display:grid;grid-template-columns:1fr 260px;gap:2rem;align-items:start;margin-top:1rem;}
.inv-payment-box{background:#f8f8f8;padding:1.25rem;border:1px solid #e8e8e8;}
.inv-payment-box h4{font-size:0.65rem;letter-spacing:0.16em;text-transform:uppercase;color:#888;margin-bottom:0.85rem;font-weight:700;}
.inv-payment-box p{font-size:0.78rem;color:#444;line-height:2;}
.inv-total-row{display:flex;justify-content:space-between;padding:0.4rem 0;font-size:0.82rem;color:#555;border-bottom:1px solid #f0f0f0;}
.inv-total-row.subtotal{}.inv-total-row.grand{font-weight:600;color:#1A1A1A;font-size:0.9rem;border-bottom:none;}
.inv-total-row.deposit-line{color:var(--green);}
.inv-balance-bar{background:#2A2A2A;color:#fff;display:flex;justify-content:space-between;padding:0.75rem 0;font-weight:700;font-size:1rem;margin-top:0.5rem;}
.inv-footer-note{text-align:center;margin-top:2rem;font-size:0.65rem;color:#bbb;border-top:1px solid #eee;padding-top:1rem;}
.inv-notes-box{margin-top:1.5rem;padding:1rem;background:#f8f8f8;border-left:3px solid #2A2A2A;font-size:0.78rem;color:#555;line-height:1.7;}

/* UTIL */
.empty-state{text-align:center;padding:4rem 2rem;color:var(--text2);}
.empty-state h3{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:400;margin-bottom:0.5rem;color:var(--text);}
.empty-state p{font-size:0.75rem;}
.toast{position:fixed;bottom:2rem;right:2rem;background:var(--charcoal);border-left:3px solid var(--gold);color:#fff;padding:0.75rem 1.25rem;font-size:0.75rem;z-index:9000;display:none;animation:fadeIn 0.2s ease;max-width:340px;font-family:'Raleway',sans-serif;}
.toast.show{display:block;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);}

@media print{
  body *{visibility:hidden;}
  #print-area,#print-area *{visibility:visible;}
  #print-area{position:fixed;left:0;top:0;width:100%;}
  .invoice-preview{border:none;padding:1.5rem;}
}
</style>
</head>
<body>

<div id="loading-screen" class="visible">
  <div class="loading-logo">Dial<span>Trader</span></div>
  <div class="loading-bar"></div>
</div>

<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">Dial<em>Trader</em></div>
    <div class="auth-tagline">Watch Trading Desk</div>
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchAuthTab('login')">Sign In</div>
      <div class="auth-tab" onclick="switchAuthTab('signup')">Create Account</div>
    </div>
    <div class="auth-form active" id="auth-login">
      <label class="auth-label">Email</label>
      <input class="auth-input" id="login-email" type="email" placeholder="you@example.com" onkeydown="if(event.key==='Enter')doLogin()">
      <label class="auth-label">Password</label>
      <input class="auth-input" id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()">
      <button class="auth-btn" id="login-btn" onclick="doLogin()">Sign In</button>
      <div class="auth-error" id="login-error"></div>
      <div style="text-align:center;margin-top:1rem"><span style="font-size:0.65rem;color:var(--text2);cursor:pointer;text-decoration:underline" onclick="doForgotPassword()">Forgot password?</span></div>
    </div>
    <div class="auth-form" id="auth-signup">
      <label class="auth-label">Email</label>
      <input class="auth-input" id="signup-email" type="email" placeholder="you@example.com">
      <label class="auth-label">Password</label>
      <input class="auth-input" id="signup-password" type="password" placeholder="Min. 8 characters">
      <label class="auth-label">Confirm Password</label>
      <input class="auth-input" id="signup-confirm" type="password" onkeydown="if(event.key==='Enter')doSignup()">
      <button class="auth-btn" id="signup-btn" onclick="doSignup()">Create Account</button>
      <div class="auth-error" id="signup-error"></div>
      <div class="auth-success" id="signup-success"></div>
    </div>
  </div>
</div>

<div id="app-screen">
  <nav class="sidebar">
    <div class="sidebar-logo">
      <div id="sidebar-logo-icon" style="width:100%;display:flex;justify-content:center;margin-bottom:0.6rem;"></div>
      <div style="text-align:center;">
        <div class="sidebar-logo-text">Dial<em>Trader</em></div>
        <div class="sidebar-logo-sub">Watch Trading Desk</div>
      </div>
    </div>
    <div class="sidebar-section-label">Main</div>
    <div class="nav-item active" onclick="showPage('dashboard')"><span class="nav-icon">üìä</span>Dashboard</div>
    <div class="nav-item" onclick="showPage('inventory')"><span class="nav-icon">üïê</span>Inventory<span class="nav-badge" id="nav-inv-count">0</span></div>
    <div class="nav-item" onclick="showPage('sold')"><span class="nav-icon">‚úÖ</span>Sold History</div>
    <div class="sidebar-section-label">Business</div>
    <div class="nav-item" onclick="showPage('contacts')"><span class="nav-icon">üë§</span>Contacts<span class="nav-badge" id="nav-contact-count">0</span></div>
    <div class="nav-item" onclick="showPage('invoices')"><span class="nav-icon">üìÑ</span>Invoices<span class="nav-badge" id="nav-invoice-count">0</span></div>
    <div class="sidebar-section-label">Tools</div>
    <div class="nav-item" onclick="showPage('import')"><span class="nav-icon">üì•</span>Import / Export</div>
    <div class="nav-item" onclick="showPage('tax')"><span class="nav-icon">üí∞</span>Tax Report</div>
    <div class="sidebar-footer">
      <div class="sidebar-user" id="sidebar-user"></div>
      <div class="sidebar-signout" onclick="doSignOut()">Sign Out</div>
    </div>
  </nav>

  <div class="main-content">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <div><div class="page-title">Dashboard</div></div>
        <button class="btn-gold" onclick="openModal()">+ Add Watch</button>
      </div>
      <div class="dash-hero">
        <div class="hero-stat"><div class="hero-label">Capital Deployed</div><div class="hero-value gold" id="stat-capital-val">‚Äî</div><div class="hero-sub" id="stat-capital-sub"></div></div>
        <div class="hero-stat"><div class="hero-label">Total Profit</div><div class="hero-value green" id="stat-profit-val">‚Äî</div><div class="hero-sub" id="stat-profit-sub"></div></div>
        <div class="hero-stat"><div class="hero-label">In Inventory</div><div class="hero-value" id="stat-inv-val">‚Äî</div><div class="hero-sub" id="stat-inv-sub"></div></div>
        <div class="hero-stat"><div class="hero-label">Avg ROI</div><div class="hero-value gold" id="stat-roi-val">‚Äî</div><div class="hero-sub">on sold watches</div></div>
      </div>
      <div class="dash-grid">
        <div class="panel">
          <div class="panel-title">Current Inventory</div>
          <table class="mini-table"><thead><tr><th>Watch</th><th>Cost Basis</th><th>Break Even</th><th>Days Held</th></tr></thead><tbody id="dash-inv-body"></tbody></table>
        </div>
        <div class="panel">
          <div class="panel-title">Profit by Brand</div>
          <div id="dash-brand-bars"></div>
        </div>
      </div>
    </div>

    <!-- INVENTORY -->
    <div class="page" id="page-inventory">
      <div class="page-header">
        <div><div class="page-title">Inventory</div><div class="page-subtitle" id="inv-subtitle"></div></div>
        <button class="btn-gold" onclick="openModal()">+ Add Watch</button>
      </div>
      <div class="filter-bar">
        <input class="search-input" id="inv-search" type="text" placeholder="Search brand, model, ref..." oninput="renderInventory()">
        <select class="filter-select" id="inv-sort" onchange="renderInventory()">
          <option value="date-desc">Newest First</option><option value="date-asc">Oldest First</option>
          <option value="cost-desc">Cost: High‚ÜíLow</option><option value="cost-asc">Cost: Low‚ÜíHigh</option>
          <option value="days-desc">Days Held: Most</option>
        </select>
      </div>
      <div class="inv-rows" id="inventory-grid">
        <div class="inv-row-header"><span>Watch / Stage</span><span>Cost Basis</span><span>MSRP</span><span>Listed At</span><span>Potential Profit</span><span>Days Held</span><span>Platform</span></div>
      </div>
      <div id="inv-empty" class="empty-state" style="display:none"><h3>No watches in inventory</h3><p>Click "+ Add Watch" to get started.</p></div>
    </div>

    <!-- SOLD -->
    <div class="page" id="page-sold">
      <div class="page-header">
        <div><div class="page-title">Sold <span>History</span></div><div class="page-subtitle" id="sold-subtitle"></div></div>
      </div>
      <div class="filter-bar">
        <input class="search-input" id="sold-search" type="text" placeholder="Search sold watches..." oninput="renderSold()">
        <select class="filter-select" id="sold-sort" onchange="renderSold()">
          <option value="date-desc">Most Recent</option><option value="profit-desc">Profit: High‚ÜíLow</option>
          <option value="profit-asc">Profit: Low‚ÜíHigh</option><option value="roi-desc">ROI: High‚ÜíLow</option>
        </select>
      </div>
      <div style="overflow-x:auto">
        <table class="sold-table">
          <thead><tr>
            <th>Brand / Model</th><th>Ref / Serial</th><th>Cost Basis</th><th>Sold Price</th><th>Platform</th>
            <th onclick="setSoldSort('profit-desc')" style="cursor:pointer">Net Profit ‚Üï</th>
            <th onclick="setSoldSort('roi-desc')" style="cursor:pointer">ROI ‚Üï</th>
            <th>Hold Days</th><th>P/Day</th><th>Photos</th><th></th>
          </tr></thead>
          <tbody id="sold-body"></tbody>
        </table>
      </div>
      <div id="sold-empty" class="empty-state" style="display:none"><h3>No sold watches yet</h3><p>Mark a watch as sold from Inventory.</p></div>
    </div>

    <!-- CONTACTS -->
    <div class="page" id="page-contacts">
      <div id="contacts-list-view">
        <div class="page-header">
          <div><div class="page-title">Contacts</div><div class="page-subtitle" id="contacts-subtitle"></div></div>
          <div style="display:flex;gap:0.5rem;align-items:center">
            <input class="search-input" id="contact-search" type="text" placeholder="Search contacts..." oninput="renderContacts()" style="width:200px">
            <button class="btn-gold" onclick="openContactModal()">+ Add Contact</button>
          </div>
        </div>
        <div class="contacts-grid" id="contacts-grid"></div>
        <div id="contacts-empty" class="empty-state" style="display:none"><h3>No contacts yet</h3><p>Add buyers and sellers to track their full transaction history.</p></div>
      </div>
      <div id="contacts-detail-view" style="display:none">
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem">
          <span style="font-size:0.7rem;color:var(--text2);cursor:pointer;letter-spacing:0.06em;text-transform:uppercase" onclick="showContactsList()">‚Üê Back to Contacts</span>
        </div>
        <div id="contact-detail-content"></div>
      </div>
    </div>

    <!-- INVOICES -->
    <div class="page" id="page-invoices">
      <div id="invoices-list-view">
        <div class="page-header">
          <div><div class="page-title">Invoices</div><div class="page-subtitle" id="invoices-subtitle"></div></div>
          <div style="display:flex;gap:0.5rem;align-items:center">
            <div style="display:flex;border:1px solid var(--border)">
              <div class="inv-tab-btn active" id="tab-sent-btn" onclick="switchInvoiceTab('sent')" style="padding:0.45rem 1rem;font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;font-weight:600;background:var(--charcoal);color:#fff;">Sent</div>
              <div class="inv-tab-btn" id="tab-received-btn" onclick="switchInvoiceTab('received')" style="padding:0.45rem 1rem;font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;font-weight:600;color:var(--text2);">Received</div>
            </div>
            <button class="btn-gold" id="new-invoice-btn" onclick="openInvoiceModal()">+ New Invoice</button>
            <button class="btn-outline" id="upload-invoice-btn" onclick="openReceivedModal()" style="display:none">+ Upload Invoice</button>
          </div>
        </div>
        <!-- SENT -->
        <div id="sent-invoices-panel">
          <div class="invoice-list" id="invoice-list"></div>
          <div id="invoices-empty" class="empty-state" style="display:none"><h3>No invoices yet</h3><p>Create an invoice to send to a buyer.</p></div>
        </div>
        <!-- RECEIVED -->
        <div id="received-invoices-panel" style="display:none">
          <div class="invoice-list" id="received-invoice-list"></div>
          <div id="received-empty" class="empty-state" style="display:none"><h3>No received invoices yet</h3><p>Upload invoices you receive from sellers when purchasing watches.</p></div>
        </div>
      </div>
      <div id="invoices-detail-view" style="display:none">
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap">
          <span style="font-size:0.7rem;color:var(--text2);cursor:pointer;letter-spacing:0.06em;text-transform:uppercase" onclick="showInvoicesList()">‚Üê Back to Invoices</span>
          <div style="margin-left:auto;display:flex;gap:0.5rem">
            <button class="btn-outline btn-sm" onclick="printInvoice()">üñ® Print / PDF</button>
            <button class="btn-outline btn-sm" onclick="editCurrentInvoice()">‚úèÔ∏è Edit</button>
            <button class="btn-gold btn-sm" id="btn-mark-paid" onclick="markInvoicePaid()">Mark Paid</button>
          </div>
        </div>
        <div id="print-area"><div id="invoice-detail-content"></div></div>
      </div>
    </div>

    <!-- IMPORT -->
    <div class="page" id="page-import">
      <div class="page-header"><div class="page-title">Import / <span>Export</span></div></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem">
        <div>
          <div class="import-instructions"><h3>Import Inventory</h3><p>Download the template, fill in your watches (one per row), then drop the CSV below.</p><br><code>brand,model,ref,serial,year,purchase_date,purchase_price,tax,shipping_in,other_fees,listed_price,platform,condition,box_papers,notes</code></div>
          <div class="import-zone" id="drop-inventory" onclick="document.getElementById('file-inventory').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="handleDrop(event,'inventory')">
            <div class="import-zone-icon">üìã</div><div class="import-zone-title">Drop Inventory CSV Here</div><div class="import-zone-sub">or click to browse</div>
          </div>
          <input type="file" id="file-inventory" accept=".csv" style="display:none" onchange="handleFileInput(event,'inventory')">
          <div style="display:flex;gap:0.5rem">
            <button class="btn-outline" onclick="downloadTemplate('inventory')">‚¨á Download Template</button>
            <button class="btn-outline" onclick="exportInventoryCSV()">‚¨Ü Export Inventory</button>
          </div>
        </div>
        <div>
          <div class="import-instructions"><h3>Import Sold History</h3><p>Download the sold template, fill it in, and drop it below.</p><br><code>brand,model,ref,serial,year,purchase_date,purchase_price,tax,shipping_in,other_fees,sale_date,sold_price,platform_fee,payment_fee,shipping_out,platform,notes</code></div>
          <div class="import-zone" id="drop-sold" onclick="document.getElementById('file-sold').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="handleDrop(event,'sold')">
            <div class="import-zone-icon">üìã</div><div class="import-zone-title">Drop Sold History CSV Here</div><div class="import-zone-sub">or click to browse</div>
          </div>
          <input type="file" id="file-sold" accept=".csv" style="display:none" onchange="handleFileInput(event,'sold')">
          <button class="btn-outline" onclick="downloadTemplate('sold')">‚¨á Download Template</button>
        </div>
      </div>
      <div id="import-preview" style="display:none;margin-top:2rem"></div>
    </div>

  </div><!-- end main-content -->

    <!-- TAX REPORT -->
    <div class="page" id="page-tax" style="display:none">
      <div class="page-header">
        <div><div class="page-title">Tax <span>Report</span></div><div class="page-subtitle">P&amp;L summary by tax year ‚Äî export for your accountant</div></div>
        <div style="display:flex;gap:0.5rem;align-items:center">
          <select class="filter-select" id="tax-year-filter" onchange="renderTaxReport()"><option value="all">All Years</option></select>
          <button class="btn-outline" onclick="exportTaxCSV()">‚¨Ü Export CSV</button>
          <button class="btn-gold" onclick="window.print()">üñ® Print Report</button>
        </div>
      </div>
      <div id="tax-report-content"></div>
    </div>
</div><!-- end app-screen -->

<!-- WATCH MODAL -->
<div class="modal-overlay" id="modal" onclick="closeModalOverlay(event)">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="modal-title">Add Watch</div><button class="modal-close" onclick="closeModal()">‚úï</button></div>
    <div class="modal-body">
      <div class="modal-tabs">
        <div class="modal-tab active" onclick="switchTab('basics')">Basics & Financials</div>
        <div class="modal-tab" onclick="switchTab('details')">Watch Details</div>
        <div class="modal-tab" onclick="switchTab('photos')">Photos</div>
        <div class="modal-tab" onclick="switchTab('wtcontacts')">Contacts</div>
        <div class="modal-tab" id="tab-sell-btn" onclick="switchTab('sell')" style="display:none">Mark as Sold</div>
      </div>
      <div class="modal-tab-panel active" id="tab-basics">
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Brand *</label><input class="form-input" id="f-brand" placeholder="e.g. Rolex"></div>
          <div class="form-group"><label class="form-label">Model *</label><input class="form-input" id="f-model" placeholder="e.g. Submariner"></div>
          <div class="form-group"><label class="form-label">Reference</label><input class="form-input" id="f-ref" placeholder="e.g. 126610LN"></div>
          <div class="form-group"><label class="form-label">Serial Number</label><input class="form-input" id="f-serial" placeholder="Watch serial number"></div>
          <div class="form-group"><label class="form-label">Year</label><input class="form-input" id="f-year" placeholder="e.g. 2021"></div>
          <div class="form-group"><label class="form-label">Purchase Date</label><input class="form-input" id="f-purchase-date" type="date"></div>
          <div class="form-group"><label class="form-label">Purchase Price ($)</label><input class="form-input" id="f-purchase-price" type="number" placeholder="0.00"></div>
          <div class="form-group"><label class="form-label">Tax ($)</label><input class="form-input" id="f-tax" type="number" placeholder="0.00"></div>
          <div class="form-group"><label class="form-label">Shipping In ($)</label><input class="form-input" id="f-shipping-in" type="number" placeholder="0.00"></div>
          <div class="form-group"><label class="form-label">Other Fees ($)</label><input class="form-input" id="f-other-fees" type="number" placeholder="0.00"></div>
          <div class="form-group"><label class="form-label">Listed Price ($)</label><input class="form-input" id="f-listed-price" type="number" placeholder="0.00"></div>
          <div class="form-group"><label class="form-label">MSRP ($)</label><input class="form-input" id="f-msrp" type="number" placeholder="Retail / market value"></div>
          <div class="form-group full"><label class="form-label">Platform(s) Listed On</label>
            <div class="platform-checks" id="f-platform-checks">
              <div class="platform-check" data-val="Grailzee" onclick="togglePlatform(this)">Grailzee</div>
              <div class="platform-check" data-val="eBay" onclick="togglePlatform(this)">eBay</div>
              <div class="platform-check" data-val="Chrono24" onclick="togglePlatform(this)">Chrono24</div>
              <div class="platform-check" data-val="Reddit" onclick="togglePlatform(this)">Reddit</div>
              <div class="platform-check" data-val="Instagram Post" onclick="togglePlatform(this)">Instagram Post</div>
              <div class="platform-check" data-val="Facebook Post" onclick="togglePlatform(this)">Facebook Post</div>
              <div class="platform-check" data-val="Facebook Marketplace" onclick="togglePlatform(this)">Facebook Marketplace</div>
              <div class="platform-check" data-val="WatchUSeek" onclick="togglePlatform(this)">WatchUSeek</div>
              <div class="platform-check" data-val="FB ‚Äî Watch Trading Academy B/S/T" onclick="togglePlatform(this)">FB ‚Äî Watch Trading Academy</div>
              <div class="platform-check" data-val="FB ‚Äî Buy My Watch" onclick="togglePlatform(this)">FB ‚Äî Buy My Watch</div>
              <div class="platform-check" data-val="FB ‚Äî Bay Watch Club" onclick="togglePlatform(this)">FB ‚Äî Bay Watch Club</div>
              <div class="platform-check" data-val="FB ‚Äî Audemars Piguet" onclick="togglePlatform(this)">FB ‚Äî Audemars Piguet</div>
              <div class="platform-check" data-val="FB ‚Äî Vintage &amp; Pre-Owned Rolex" onclick="togglePlatform(this)">FB ‚Äî Vintage &amp; Pre-Owned Rolex</div>
              <div class="platform-check" data-val="FB ‚Äî Moda Watch Club" onclick="togglePlatform(this)">FB ‚Äî Moda Watch Club</div>
              <div class="platform-check" data-val="Other" onclick="togglePlatform(this)">Other</div>
            </div>
          </div>
          <div class="form-group full"><label class="form-label">Link to Contact</label><select class="form-select" id="f-contact-link"><option value="">‚Äî None ‚Äî</option></select></div>
          <div class="form-group full">
            <label class="form-label">Deal Stage</label>
            <div class="stage-selector" id="f-stage-selector"></div>
          </div>
          <div class="form-group full"><label class="form-label">Notes</label><textarea class="form-textarea" id="f-notes" placeholder="Additional notes..."></textarea></div>
        </div>
      </div>
      <div class="modal-tab-panel" id="tab-details">
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Condition</label>
            <select class="form-select" id="f-condition"><option value="">‚Äî Select ‚Äî</option><option>New / Unworn</option><option>Mint (9/10)</option><option>Excellent (8/10)</option><option>Very Good (7/10)</option><option>Good (6/10)</option><option>Fair (5/10)</option><option>Parts/Repair</option></select>
          </div>
          <div class="form-group"><label class="form-label">Box & Papers</label>
            <select class="form-select" id="f-box-papers"><option value="">‚Äî Select ‚Äî</option><option>Full Set (Box + Papers)</option><option>Box Only</option><option>Papers Only</option><option>No Box, No Papers</option></select>
          </div>
          <div class="form-group"><label class="form-label">Case Size (mm)</label><input class="form-input" id="f-case-size" placeholder="e.g. 41"></div>
          <div class="form-group"><label class="form-label">Case Material</label>
            <select class="form-select" id="f-case-material"><option value="">‚Äî Select ‚Äî</option><option>Stainless Steel</option><option>Yellow Gold</option><option>White Gold</option><option>Rose Gold</option><option>Two-Tone</option><option>Titanium</option><option>Ceramic</option><option>Platinum</option></select>
          </div>
          <div class="form-group"><label class="form-label">Movement</label>
            <select class="form-select" id="f-movement"><option value="">‚Äî Select ‚Äî</option><option>Automatic</option><option>Manual Wind</option><option>Quartz</option><option>Solar</option><option>Spring Drive</option></select>
          </div>
          <div class="form-group"><label class="form-label">Bracelet Type</label>
            <select class="form-select" id="f-bracelet-type"><option value="">‚Äî Select ‚Äî</option><option>Oyster/Metal Bracelet</option><option>Jubilee</option><option>President</option><option>Leather Strap</option><option>Rubber Strap</option><option>NATO Strap</option><option>Integrated Bracelet</option></select>
          </div>
          <div class="form-group"><label class="form-label">Dial Color</label><input class="form-input" id="f-dial-color" placeholder="e.g. Black, Blue, Green"><div class="color-row" id="dial-colors"></div></div>
          <div class="form-group"><label class="form-label">Bezel Color</label><input class="form-input" id="f-bezel-color" placeholder="e.g. Black, Blue"><div class="color-row" id="bezel-colors"></div></div>
          <div class="form-group"><label class="form-label">Bracelet Color</label><input class="form-input" id="f-bracelet-color" placeholder="e.g. Steel, Black"></div>
        </div>
      </div>
      <div class="modal-tab-panel" id="tab-photos">
        <div style="font-size:0.68rem;color:var(--text2);margin-bottom:1rem;line-height:1.6"><strong>First photo = main storefront image.</strong> Drag to reorder. JPG/PNG only ‚Äî HEIC not supported.</div>
        <div id="photo-upload-zone" style="border:2px dashed var(--border2);padding:2rem;text-align:center;cursor:pointer;transition:border-color 0.2s;margin-bottom:1rem">
          <div style="font-size:2rem;margin-bottom:0.5rem;opacity:0.4">üì∑</div>
          <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--text2)">Click or drop photos here</div>
          <div style="font-size:0.68rem;color:var(--text2);margin-top:0.25rem">JPG, PNG ‚Äî max 5MB each</div>
        </div>
        <input type="file" id="photo-file-input" accept="image/*" multiple style="display:none">
        <div id="photo-preview-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem"></div>
        <div id="photo-upload-status" style="font-size:0.7rem;color:var(--text2);margin-top:0.5rem;text-align:center"></div>
      </div>
      <div class="modal-tab-panel" id="tab-wtcontacts">
        <div class="contact-card-form"><div class="contact-card-form-title">‚ñ∏ Purchased From</div>
          <div class="form-grid">
            <div class="form-group full"><label class="form-label">Name</label><input class="form-input" id="f-buy-name" placeholder="Full name or business"></div>
            <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="f-buy-phone" type="tel"></div>
            <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="f-buy-email" type="email"></div>
            <div class="form-group full"><label class="form-label">Location</label><input class="form-input" id="f-buy-location"></div>
          </div>
        </div>
        <div class="contact-card-form"><div class="contact-card-form-title">‚ñ∏ Sold To (pre-fill or complete at sale)</div>
          <div class="form-grid">
            <div class="form-group full"><label class="form-label">Name</label><input class="form-input" id="f-sell-name" placeholder="Buyer name"></div>
            <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="f-sell-phone" type="tel"></div>
            <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="f-sell-email" type="email"></div>
            <div class="form-group full"><label class="form-label">Location</label><input class="form-input" id="f-sell-location"></div>
          </div>
        </div>
      </div>
      <div class="modal-tab-panel" id="tab-sell">
        <div style="font-size:0.78rem;color:var(--text2);margin-bottom:1.25rem;line-height:1.7">Complete sale details below. The watch moves to Sold History.</div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Sale Date</label><input class="form-input" id="f-sale-date" type="date"></div>
          <div class="form-group"><label class="form-label">Sold Price ($) *</label><input class="form-input" id="f-sold-price" type="number" placeholder="0.00" oninput="updateSellPnL()"></div>
          <div class="form-group"><label class="form-label">Platform Fee ($)</label><input class="form-input" id="f-platform-fee" type="number" placeholder="0.00" oninput="updateSellPnL()"></div>
          <div class="form-group"><label class="form-label">Payment Fee ($)</label><input class="form-input" id="f-payment-fee" type="number" placeholder="0.00" oninput="updateSellPnL()"></div>
          <div class="form-group"><label class="form-label">Shipping Out ($)</label><input class="form-input" id="f-shipping-out" type="number" placeholder="0.00" oninput="updateSellPnL()"></div>
          <div class="form-group full"><label class="form-label">Sale Platform</label>
            <div class="platform-checks" id="f-sale-platform-checks">
              <div class="platform-check" data-val="Grailzee" onclick="togglePlatform(this)">Grailzee</div>
              <div class="platform-check" data-val="eBay" onclick="togglePlatform(this)">eBay</div>
              <div class="platform-check" data-val="Chrono24" onclick="togglePlatform(this)">Chrono24</div>
              <div class="platform-check" data-val="Reddit" onclick="togglePlatform(this)">Reddit</div>
              <div class="platform-check" data-val="Instagram Post" onclick="togglePlatform(this)">Instagram Post</div>
              <div class="platform-check" data-val="Facebook Post" onclick="togglePlatform(this)">Facebook Post</div>
              <div class="platform-check" data-val="Facebook Marketplace" onclick="togglePlatform(this)">Facebook Marketplace</div>
              <div class="platform-check" data-val="WatchUSeek" onclick="togglePlatform(this)">WatchUSeek</div>
              <div class="platform-check" data-val="FB ‚Äî Watch Trading Academy B/S/T" onclick="togglePlatform(this)">FB ‚Äî Watch Trading Academy</div>
              <div class="platform-check" data-val="FB ‚Äî Buy My Watch" onclick="togglePlatform(this)">FB ‚Äî Buy My Watch</div>
              <div class="platform-check" data-val="FB ‚Äî Bay Watch Club" onclick="togglePlatform(this)">FB ‚Äî Bay Watch Club</div>
              <div class="platform-check" data-val="FB ‚Äî Audemars Piguet" onclick="togglePlatform(this)">FB ‚Äî Audemars Piguet</div>
              <div class="platform-check" data-val="FB ‚Äî Vintage &amp; Pre-Owned Rolex" onclick="togglePlatform(this)">FB ‚Äî Vintage &amp; Pre-Owned Rolex</div>
              <div class="platform-check" data-val="FB ‚Äî Moda Watch Club" onclick="togglePlatform(this)">FB ‚Äî Moda Watch Club</div>
              <div class="platform-check" data-val="Other" onclick="togglePlatform(this)">Other</div>
            </div>
          </div>
          <div class="form-group full"><label class="form-label">Sold To (Name)</label><input class="form-input" id="f-sell-name-sell" placeholder="Buyer name"></div>
          <div class="form-group"><label class="form-label">Buyer Phone</label><input class="form-input" id="f-sell-phone-sell" type="tel"></div>
          <div class="form-group"><label class="form-label">Buyer Email</label><input class="form-input" id="f-sell-email-sell" type="email"></div>
        </div>
        <div id="sell-pnl" style="margin-top:1rem;padding:1rem;background:var(--surface2);border:1px solid var(--border);font-size:0.8rem;color:var(--text2)">Enter sold price above to see projected profit.</div>
        <button class="btn-gold" style="width:100%;padding:0.9rem;margin-top:1rem" onclick="markAsSold()">‚úì Confirm Sale & Move to Sold History</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="btn-delete" onclick="deleteWatch()" style="display:none">Delete</button>
      <div class="modal-actions">
        <button class="btn-outline" onclick="closeModal()">Cancel</button>
        <button class="btn-gold" id="btn-save" onclick="saveWatch()">Save Watch</button>
      </div>
    </div>
  </div>
</div>

<!-- CONTACT MODAL -->
<div class="modal-overlay" id="contact-modal" onclick="if(event.target===this)closeContactModal()">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="contact-modal-title">Add Contact</div><button class="modal-close" onclick="closeContactModal()">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label class="form-label">Full Name *</label><input class="form-input" id="cf-name" placeholder="Full name"></div>
        <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="cf-phone" type="tel" placeholder="(555) 000-0000"></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="cf-email" type="email" placeholder="contact@email.com"></div>
        <div class="form-group full"><label class="form-label">Street Address</label><input class="form-input" id="cf-address" placeholder="Street address"></div>
        <div class="form-group"><label class="form-label">City</label><input class="form-input" id="cf-city" placeholder="City"></div>
        <div class="form-group"><label class="form-label">State / ZIP</label><input class="form-input" id="cf-state" placeholder="AR 72034"></div>
        <div class="form-group full"><label class="form-label">Notes</label><textarea class="form-textarea" id="cf-notes" placeholder="Notes about this contact..."></textarea></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="cf-delete-btn" onclick="deleteContact()" style="display:none">Delete</button>
      <div class="modal-actions">
        <button class="btn-outline" onclick="closeContactModal()">Cancel</button>
        <button class="btn-gold" onclick="saveContact()">Save Contact</button>
      </div>
    </div>
  </div>
</div>

<!-- INVOICE MODAL -->
<div class="modal-overlay" id="invoice-modal" onclick="if(event.target===this)closeInvoiceModal()">
  <div class="modal modal-lg">
    <div class="modal-header"><div class="modal-title" id="invoice-modal-title">New Invoice</div><button class="modal-close" onclick="closeInvoiceModal()">‚úï</button></div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">
        <div>
          <div class="section-divider">Bill To</div>
          <div class="form-group" style="margin-bottom:0.75rem">
            <label class="form-label">Select Existing Contact</label>
            <select class="form-select" id="inv-contact-select" onchange="fillInvoiceContact()"><option value="">‚Äî Manual entry ‚Äî</option></select>
          </div>
          <div class="form-grid">
            <div class="form-group full"><label class="form-label">Name *</label><input class="form-input" id="inv-bill-name" placeholder="Full name"></div>
            <div class="form-group full"><label class="form-label">Street Address</label><input class="form-input" id="inv-bill-address" placeholder="Street address"></div>
            <div class="form-group"><label class="form-label">City, State ZIP</label><input class="form-input" id="inv-bill-city" placeholder="City, AR 72034"></div>
            <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="inv-bill-phone" type="tel" placeholder="(555) 000-0000"></div>
            <div class="form-group full"><label class="form-label">Email</label><input class="form-input" id="inv-bill-email" type="email" placeholder="buyer@email.com"></div>
          </div>
        </div>
        <div>
          <div class="section-divider">Invoice Details</div>
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Invoice #</label><input class="form-input" id="inv-number" placeholder="e.g. 26-154"></div>
            <div class="form-group"><label class="form-label">Invoice Date</label><input class="form-input" id="inv-date" type="date"></div>
            <div class="form-group"><label class="form-label">Due Date</label><input class="form-input" id="inv-due-date" type="date"></div>
            <div class="form-group"><label class="form-label">Deposit Received ($)</label><input class="form-input" id="inv-deposit" type="number" placeholder="0.00" oninput="updateInvoiceTotals()"></div>
            <div class="form-group full"><label class="form-label">Notes / Terms</label><textarea class="form-textarea" id="inv-notes" placeholder="Payment terms, delivery notes..." style="min-height:55px"></textarea></div>
          </div>
        </div>
      </div>
      <div class="section-divider">Line Items</div>
      <div id="inv-line-items" style="margin-bottom:0.75rem"></div>
      <div style="display:flex;gap:0.5rem;margin-bottom:1.5rem">
        <button class="btn-outline btn-sm" onclick="addInvoiceLineFromInventory()">+ From Inventory</button>
        <button class="btn-outline btn-sm" onclick="addInvoiceLineManual()">+ Manual Item</button>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-bottom:1.5rem">
        <div style="width:300px">
          <div style="display:flex;justify-content:space-between;padding:0.4rem 0;font-size:0.82rem;color:var(--text2);border-bottom:1px solid var(--border)"><span>Subtotal</span><span id="inv-preview-subtotal">$0.00</span></div>
          <div id="inv-deposit-row" style="display:none;justify-content:space-between;padding:0.4rem 0;font-size:0.82rem;color:var(--green);border-bottom:1px solid var(--border)"><span>Deposit</span><span id="inv-preview-deposit"></span></div>
          <div style="display:flex;justify-content:space-between;padding:0.5rem 0;font-size:0.9rem;font-weight:600;color:var(--text)"><span>Balance Due</span><span id="inv-preview-balance">$0.00</span></div>
        </div>
      </div>
      <div class="section-divider">Payment Instructions (toggle what to show)</div>
      <div style="display:flex;gap:1.5rem;flex-wrap:wrap;margin-bottom:0.5rem">
        <label style="display:flex;align-items:center;gap:0.5rem;font-size:0.78rem;cursor:pointer"><input type="checkbox" id="inv-show-zelle"> Show Zelle</label>
        <label style="display:flex;align-items:center;gap:0.5rem;font-size:0.78rem;cursor:pointer"><input type="checkbox" id="inv-show-apple"> Show Apple Pay</label>
        <label style="display:flex;align-items:center;gap:0.5rem;font-size:0.78rem;cursor:pointer"><input type="checkbox" id="inv-show-wire"> Show Wire Transfer</label>
      </div>
      <div style="font-size:0.65rem;color:var(--text2)">Wire instructions will only appear on the invoice if you check the box above ‚Äî they are hidden by default.</div>
    </div>
    <div class="modal-footer">
      <span style="font-size:0.7rem;color:var(--text2)">Saved invoices can be printed to PDF</span>
      <div class="modal-actions">
        <button class="btn-outline" onclick="closeInvoiceModal()">Cancel</button>
        <button class="btn-gold" onclick="saveInvoice()">Save & Preview</button>
      </div>
    </div>
  </div>
</div>

<!-- INVENTORY PICKER -->
<div class="modal-overlay" id="inv-picker-modal" onclick="if(event.target===this)closeInvPicker()">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Select from Inventory</div><button class="modal-close" onclick="closeInvPicker()">‚úï</button></div>
    <div class="modal-body">
      <input class="search-input" id="inv-picker-search" type="text" placeholder="Search inventory..." oninput="renderInvPicker()" style="width:100%;margin-bottom:1rem">
      <div id="inv-picker-list" style="max-height:380px;overflow-y:auto;border:1px solid var(--border)"></div>
    </div>
  </div>
</div>

<!-- SOLD PHOTO MODAL -->
<div class="modal-overlay" id="sold-photo-modal" onclick="if(event.target===this)closeSoldPhotoModal()">
  <div class="modal" style="max-width:520px">
    <div class="modal-header"><div class="modal-title" id="sold-photo-modal-title">Edit Photos</div><button class="modal-close" onclick="closeSoldPhotoModal()">‚úï</button></div>
    <div class="modal-body">
      <div style="font-size:0.72rem;color:var(--text2);margin-bottom:1rem;line-height:1.6">First photo = storefront image. Drag to reorder. JPG/PNG only.</div>
      <div id="sold-photo-upload-zone" style="border:2px dashed var(--border2);padding:2rem;text-align:center;cursor:pointer;transition:border-color 0.2s;margin-bottom:1rem">
        <div style="font-size:2rem;margin-bottom:0.5rem;opacity:0.4">üì∑</div>
        <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--text2)">Click or drop photos here</div>
      </div>
      <input type="file" id="sold-photo-file-input" accept="image/*" multiple style="display:none">
      <div id="sold-photo-preview-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem"></div>
      <div id="sold-photo-status" style="font-size:0.7rem;color:var(--text2);margin-top:0.5rem;text-align:center"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeSoldPhotoModal()">Cancel</button>
      <button class="btn-gold" id="sold-photo-save-btn" onclick="saveSoldPhotos()">Save Photos</button>
    </div>
  </div>
</div>

<!-- RECEIVED INVOICE MODAL -->
<div class="modal-overlay" id="received-modal" onclick="if(event.target===this)closeReceivedModal()">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="received-modal-title">Upload Received Invoice</div><button class="modal-close" onclick="closeReceivedModal()">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label class="form-label">From (Seller Name)</label><input class="form-input" id="ri-seller" placeholder="Who sent this invoice?"></div>
        <div class="form-group"><label class="form-label">Invoice Date</label><input class="form-input" id="ri-date" type="date"></div>
        <div class="form-group"><label class="form-label">Amount ($)</label><input class="form-input" id="ri-amount" type="number" placeholder="0.00"></div>
        <div class="form-group full"><label class="form-label">Link to Watch in Inventory</label><select class="form-select" id="ri-watch-link"><option value="">‚Äî None / not yet in inventory ‚Äî</option></select></div>
        <div class="form-group full"><label class="form-label">Notes</label><textarea class="form-textarea" id="ri-notes" placeholder="Notes about this purchase..."></textarea></div>
      </div>
      <div style="margin-top:1rem">
        <label class="form-label">Invoice File (PDF or Image)</label>
        <div id="ri-upload-zone" style="border:2px dashed var(--border2);padding:2rem;text-align:center;cursor:pointer;margin-top:0.4rem;transition:border-color 0.2s" onclick="document.getElementById('ri-file-input').click()" ondragover="event.preventDefault();this.style.borderColor='var(--gold)'" ondragleave="this.style.borderColor=''" ondrop="handleRiDrop(event)">
          <div style="font-size:2rem;margin-bottom:0.5rem;opacity:0.4">üìé</div>
          <div style="font-family:'Playfair Display',serif;font-size:1rem;color:var(--text2)" id="ri-upload-label">Drop PDF or image here, or click to browse</div>
          <div style="font-size:0.68rem;color:var(--text2);margin-top:0.25rem">PDF, JPG, PNG</div>
        </div>
        <input type="file" id="ri-file-input" accept=".pdf,image/*" style="display:none" onchange="handleRiFile(event)">
        <div id="ri-file-preview" style="margin-top:0.75rem;display:none">
          <div style="background:var(--surface2);border:1px solid var(--border);padding:0.75rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:1.5rem">üìÑ</span>
            <div>
              <div style="font-size:0.8rem;font-weight:500" id="ri-file-name"></div>
              <div style="font-size:0.65rem;color:var(--text2)" id="ri-file-size"></div>
            </div>
            <button onclick="clearRiFile()" style="margin-left:auto;background:none;border:none;color:var(--red);cursor:pointer;font-size:1.1rem">‚úï</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="ri-delete-btn" onclick="deleteReceivedInvoice()" style="display:none">Delete</button>
      <div class="modal-actions">
        <button class="btn-outline" onclick="closeReceivedModal()">Cancel</button>
        <button class="btn-gold" onclick="saveReceivedInvoice()">Save Invoice</button>
      </div>
    </div>
  </div>
</div>

<!-- SOLD EDIT MODAL -->
<div class="modal-overlay" id="sold-edit-modal" onclick="if(event.target===this)closeSoldEditModal()">
  <div class="modal modal-lg">
    <div class="modal-header"><div class="modal-title" id="sold-edit-title">Edit Sold Watch</div><button class="modal-close" onclick="closeSoldEditModal()">‚úï</button></div>
    <div class="modal-body">
      <div class="modal-tabs">
        <div class="modal-tab active" onclick="switchSoldTab('se-basics')">Sale Details</div>
        <div class="modal-tab" onclick="switchSoldTab('se-watch')">Watch Info</div>
        <div class="modal-tab" onclick="switchSoldTab('se-contacts')">Buyer / Seller</div>
      </div>
      <div class="modal-tab-panel active" id="tab-se-basics">
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Sale Date</label><input class="form-input" id="se-sale-date" type="date"></div>
          <div class="form-group"><label class="form-label">Sold Price ($)</label><input class="form-input" id="se-sold-price" type="number"></div>
          <div class="form-group"><label class="form-label">Platform Fee ($)</label><input class="form-input" id="se-platform-fee" type="number"></div>
          <div class="form-group"><label class="form-label">Payment Fee ($)</label><input class="form-input" id="se-payment-fee" type="number"></div>
          <div class="form-group"><label class="form-label">Shipping Out ($)</label><input class="form-input" id="se-shipping-out" type="number"></div>
          <div class="form-group"><label class="form-label">Purchase Date</label><input class="form-input" id="se-purchase-date" type="date"></div>
          <div class="form-group"><label class="form-label">Purchase Price ($)</label><input class="form-input" id="se-purchase-price" type="number"></div>
          <div class="form-group"><label class="form-label">Tax ($)</label><input class="form-input" id="se-tax" type="number"></div>
          <div class="form-group"><label class="form-label">Shipping In ($)</label><input class="form-input" id="se-shipping-in" type="number"></div>
          <div class="form-group"><label class="form-label">Other Fees ($)</label><input class="form-input" id="se-other-fees" type="number"></div>
          <div class="form-group full"><label class="form-label">Sale Platform</label>
            <div class="platform-checks" id="se-platform-checks">
              <div class="platform-check" data-val="Grailzee" onclick="togglePlatform(this)">Grailzee</div>
              <div class="platform-check" data-val="eBay" onclick="togglePlatform(this)">eBay</div>
              <div class="platform-check" data-val="Chrono24" onclick="togglePlatform(this)">Chrono24</div>
              <div class="platform-check" data-val="Reddit" onclick="togglePlatform(this)">Reddit</div>
              <div class="platform-check" data-val="Instagram Post" onclick="togglePlatform(this)">Instagram Post</div>
              <div class="platform-check" data-val="Facebook Post" onclick="togglePlatform(this)">Facebook Post</div>
              <div class="platform-check" data-val="Facebook Marketplace" onclick="togglePlatform(this)">Facebook Marketplace</div>
              <div class="platform-check" data-val="WatchUSeek" onclick="togglePlatform(this)">WatchUSeek</div>
              <div class="platform-check" data-val="FB ‚Äî Watch Trading Academy B/S/T" onclick="togglePlatform(this)">FB ‚Äî Watch Trading Academy</div>
              <div class="platform-check" data-val="FB ‚Äî Buy My Watch" onclick="togglePlatform(this)">FB ‚Äî Buy My Watch</div>
              <div class="platform-check" data-val="FB ‚Äî Bay Watch Club" onclick="togglePlatform(this)">FB ‚Äî Bay Watch Club</div>
              <div class="platform-check" data-val="FB ‚Äî Audemars Piguet" onclick="togglePlatform(this)">FB ‚Äî Audemars Piguet</div>
              <div class="platform-check" data-val="FB ‚Äî Vintage &amp; Pre-Owned Rolex" onclick="togglePlatform(this)">FB ‚Äî Vintage &amp; Pre-Owned Rolex</div>
              <div class="platform-check" data-val="FB ‚Äî Moda Watch Club" onclick="togglePlatform(this)">FB ‚Äî Moda Watch Club</div>
              <div class="platform-check" data-val="Other" onclick="togglePlatform(this)">Other</div>
            </div>
          </div>
          <div class="form-group full"><label class="form-label">Notes</label><textarea class="form-textarea" id="se-notes"></textarea></div>
        </div>
      </div>
      <div class="modal-tab-panel" id="tab-se-watch">
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Brand</label><input class="form-input" id="se-brand"></div>
          <div class="form-group"><label class="form-label">Model</label><input class="form-input" id="se-model"></div>
          <div class="form-group"><label class="form-label">Reference</label><input class="form-input" id="se-ref"></div>
          <div class="form-group"><label class="form-label">Serial</label><input class="form-input" id="se-serial"></div>
          <div class="form-group"><label class="form-label">Year</label><input class="form-input" id="se-year"></div>
          <div class="form-group"><label class="form-label">Condition</label>
            <select class="form-select" id="se-condition"><option value="">‚Äî Select ‚Äî</option><option>New / Unworn</option><option>Mint (9/10)</option><option>Excellent (8/10)</option><option>Very Good (7/10)</option><option>Good (6/10)</option><option>Fair (5/10)</option><option>Parts/Repair</option></select>
          </div>
          <div class="form-group"><label class="form-label">Box & Papers</label>
            <select class="form-select" id="se-box-papers"><option value="">‚Äî Select ‚Äî</option><option>Full Set (Box + Papers)</option><option>Box Only</option><option>Papers Only</option><option>No Box, No Papers</option></select>
          </div>
          <div class="form-group"><label class="form-label">Case Size (mm)</label><input class="form-input" id="se-case-size"></div>
          <div class="form-group"><label class="form-label">Dial Color</label><input class="form-input" id="se-dial-color"></div>
        </div>
      </div>
      <div class="modal-tab-panel" id="tab-se-contacts">
        <div class="contact-card-form"><div class="contact-card-form-title">‚ñ∏ Purchased From</div>
          <div class="form-grid">
            <div class="form-group full"><label class="form-label">Name</label><input class="form-input" id="se-buy-name"></div>
            <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="se-buy-phone" type="tel"></div>
            <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="se-buy-email" type="email"></div>
          </div>
        </div>
        <div class="contact-card-form"><div class="contact-card-form-title">‚ñ∏ Sold To</div>
          <div class="form-grid">
            <div class="form-group full"><label class="form-label">Name</label><input class="form-input" id="se-sell-name"></div>
            <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="se-sell-phone" type="tel"></div>
            <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="se-sell-email" type="email"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <span style="font-size:0.7rem;color:var(--text2)">Editing does not affect sold status</span>
      <div class="modal-actions">
        <button class="btn-outline" onclick="closeSoldEditModal()">Cancel</button>
        <button class="btn-gold" onclick="saveSoldEdit()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<script>
const{createClient}=supabase;
const LOGO_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 700" width="600" height="700">

  <defs>
    <!-- Gold Radial Depth -->
    <radialGradient id="goldCore" cx="50%" cy="45%" r="65%">
      <stop offset="0%" stop-color="#FFF3B5"></stop>
      <stop offset="30%" stop-color="#E5C15A"></stop>
      <stop offset="65%" stop-color="#C89E2F"></stop>
      <stop offset="100%" stop-color="#8A6A1F"></stop>
    </radialGradient>

    <!-- Bezel Edge Shine -->
    <linearGradient id="goldEdge" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#FFF6CC"></stop>
      <stop offset="50%" stop-color="#D4A63A"></stop>
      <stop offset="100%" stop-color="#7A5A18"></stop>
    </linearGradient>

    <!-- Subtle Shadow -->
    <filter id="shadow">
      <feDropShadow dx="0" dy="6" stdDeviation="8" flood-color="#000" flood-opacity="0.5"></feDropShadow>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="600" height="700" fill="#0A0A0A"></rect>

  <!-- ===== OUTER BEZEL ===== -->
  <circle cx="300" cy="330" r="210" fill="none" stroke="url(#goldCore)" stroke-width="50" filter="url(#shadow)"></circle>

  <!-- Inner Bezel Highlight -->
  <circle cx="300" cy="330" r="180" fill="none" stroke="url(#goldEdge)" stroke-width="3" opacity="0.7"></circle>

  <!-- ===== DIAL FACE ===== -->
  <circle cx="300" cy="330" r="160" fill="#0E0E0E" stroke="url(#goldEdge)" stroke-width="2"></circle>

  <!-- ===== HOUR MARKERS ===== -->
  <!-- Major markers -->
  <g stroke="url(#goldEdge)" stroke-width="6">
    <line x1="300" y1="160" x2="300" y2="190"></line>
    <line x1="300" y1="470" x2="300" y2="500"></line>
    <line x1="130" y1="330" x2="160" y2="330"></line>
    <line x1="440" y1="330" x2="470" y2="330"></line>
  </g>

  <!-- Minor markers -->
  <g stroke="url(#goldEdge)" stroke-width="3" opacity="0.7">
    <!-- 8 evenly spaced -->
    <line x1="380" y1="180" x2="395" y2="200"></line>
    <line x1="420" y1="230" x2="440" y2="245"></line>
    <line x1="420" y1="430" x2="440" y2="415"></line>
    <line x1="380" y1="480" x2="395" y2="460"></line>
    <line x1="220" y1="480" x2="205" y2="460"></line>
    <line x1="180" y1="430" x2="160" y2="415"></line>
    <line x1="180" y1="230" x2="160" y2="245"></line>
    <line x1="220" y1="180" x2="205" y2="200"></line>
  </g>

  <!-- ===== HANDS (Set at 10:10) ===== -->
  <g stroke="url(#goldEdge)" stroke-linecap="round">
    <!-- Hour hand -->
    <line x1="300" y1="330" x2="250" y2="260" stroke-width="10"></line>
    <!-- Minute hand -->
    <line x1="300" y1="330" x2="380" y2="250" stroke-width="6"></line>
  </g>

  <!-- Center Pin -->
  <circle cx="300" cy="330" r="10" fill="url(#goldEdge)"></circle>

  <!-- ===== WORDMARK ===== -->
  <text x="300" y="630" font-family="Georgia, 'Times New Roman', serif" font-size="48" font-weight="700" fill="url(#goldEdge)" text-anchor="middle" letter-spacing="10">
        DIALTRADER
  </text>

</svg>`;
const db=createClient(SUPABASE_URL,SUPABASE_ANON);
let currentUser=null,inventory=[],soldWatches=[],contacts=[],invoices=[];
let editingId=null,editingContactId=null,editingInvoiceId=null;
let invoiceLineItems=[],currentInvoiceData=null;

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initAuth(){
  const{data:{session}}=await db.auth.getSession();
  if(session?.user){currentUser=session.user;await showApp();}
  else showAuthScreen();
  db.auth.onAuthStateChange(async(event,session)=>{
    if(event==='SIGNED_IN'&&!currentUser){currentUser=session.user;await showApp();}
    else if(event==='SIGNED_IN'&&currentUser){currentUser=session.user;}
    else if(event==='SIGNED_OUT'){currentUser=null;inventory=[];soldWatches=[];contacts=[];invoices=[];showAuthScreen();}
  });
}
function showAuthScreen(){document.getElementById('loading-screen').classList.remove('visible');document.getElementById('app-screen').classList.remove('visible');document.getElementById('auth-screen').classList.add('visible');}
async function showApp(){
  document.getElementById('auth-screen').classList.remove('visible');
  document.getElementById('loading-screen').classList.add('visible');
  document.getElementById('app-screen').classList.remove('visible');
  document.getElementById('sidebar-user').textContent=currentUser.email;
  await loadAllData();
  document.getElementById('loading-screen').classList.remove('visible');
  document.getElementById('app-screen').classList.add('visible');
  renderDashboard();
}
function switchAuthTab(tab){document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.auth-form').forEach(f=>f.classList.remove('active'));document.querySelector(`.auth-tab[onclick="switchAuthTab('${tab}')"]`).classList.add('active');document.getElementById('auth-'+tab).classList.add('active');}
async function doLogin(){const email=document.getElementById('login-email').value.trim(),pw=document.getElementById('login-password').value,btn=document.getElementById('login-btn'),err=document.getElementById('login-error');err.textContent='';if(!email||!pw){err.textContent='Please enter email and password.';return;}btn.disabled=true;btn.textContent='Signing in...';const{error}=await db.auth.signInWithPassword({email,password:pw});btn.disabled=false;btn.textContent='Sign In';if(error)err.textContent=error.message;}
async function doSignup(){const email=document.getElementById('signup-email').value.trim(),pw=document.getElementById('signup-password').value,confirm=document.getElementById('signup-confirm').value,btn=document.getElementById('signup-btn'),err=document.getElementById('signup-error'),succ=document.getElementById('signup-success');err.textContent='';succ.textContent='';if(!email||!pw){err.textContent='Fill in all fields.';return;}if(pw!==confirm){err.textContent='Passwords do not match.';return;}if(pw.length<8){err.textContent='Password must be 8+ characters.';return;}btn.disabled=true;btn.textContent='Creating...';const{error}=await db.auth.signUp({email,password:pw});btn.disabled=false;btn.textContent='Create Account';if(error)err.textContent=error.message;else succ.textContent='Check your email to confirm.';}
async function doForgotPassword(){const email=document.getElementById('login-email').value.trim();if(!email){document.getElementById('login-error').textContent='Enter your email above first.';return;}await db.auth.resetPasswordForEmail(email);document.getElementById('login-error').style.color='var(--green)';document.getElementById('login-error').textContent='Reset email sent.';}
async function doSignOut(){await db.auth.signOut();}

// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAllData(){
  const[invRes,soldRes,contactRes,invoiceRes,receivedRes]=await Promise.all([
    db.from('inventory').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false}),
    db.from('sold_inventory').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false}),
    db.from('contacts').select('*').eq('user_id',currentUser.id).order('name',{ascending:true}),
    db.from('invoices').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false}),
    db.from('received_invoices').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false}),
  ]);
  inventory=invRes.data||[];soldWatches=soldRes.data||[];contacts=contactRes.data||[];invoices=invoiceRes.data||[];receivedInvoices=receivedRes.data||[];
  updateNavBadges();populateContactDropdowns();
}
function updateNavBadges(){document.getElementById('nav-inv-count').textContent=inventory.length;document.getElementById('nav-contact-count').textContent=contacts.length;document.getElementById('nav-invoice-count').textContent=invoices.length;}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>{p.classList.remove('active');p.style.display='none';});
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const pg=document.getElementById('page-'+name);if(pg){pg.style.display='block';pg.classList.add('active');}
  const navEl=document.querySelector(`.nav-item[onclick="showPage('${name}')"]`);if(navEl)navEl.classList.add('active');
  if(name==='dashboard')renderDashboard();
  if(name==='inventory')renderInventory();
  if(name==='sold')renderSold();
  if(name==='contacts')renderContacts();
  if(name==='invoices')renderInvoices();
  if(name==='tax')renderTaxReport();
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmt(n,d=0){if(n==null||isNaN(n))return'‚Äî';return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:d,maximumFractionDigits:d}).format(n);}
function fmtPct(n){if(n==null||isNaN(n)||!isFinite(n))return'‚Äî';return(n>=0?'+':'')+n.toFixed(1)+'%';}
function daysHeld(start,end){if(!start)return null;return Math.floor((new Date(end||Date.now())-new Date(start))/86400000);}
function costBasis(w){return(+w.purchase_price||0)+(+w.tax||0)+(+w.shipping_in||0)+(+w.other_fees||0);}
function soldCostBasis(s){return(+s.purchase_price||0)+(+s.tax||0)+(+s.shipping_in||0)+(+s.other_fees||0);}
function soldNetProfit(s){return(+s.sold_price||0)-(+s.platform_fee||0)-(+s.payment_fee||0)-(+s.shipping_out||0)-soldCostBasis(s);}
function soldROI(s){const b=soldCostBasis(s);return b?soldNetProfit(s)/b*100:0;}
function showToast(m,dur=3500){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),dur);}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDashboard(){
  const cap=inventory.reduce((s,w)=>s+costBasis(w),0);
  const prof=soldWatches.reduce((s,w)=>s+soldNetProfit(w),0);
  const rois=soldWatches.map(soldROI).filter(r=>isFinite(r));
  const avgROI=rois.length?rois.reduce((a,b)=>a+b)/rois.length:0;
  document.getElementById('stat-capital-val').textContent=fmt(cap);
  document.getElementById('stat-capital-sub').textContent=`across ${inventory.length} watches`;
  document.getElementById('stat-profit-val').textContent=fmt(prof);
  document.getElementById('stat-profit-sub').textContent=`from ${soldWatches.length} sold`;
  document.getElementById('stat-inv-val').textContent=inventory.length;
  document.getElementById('stat-inv-sub').textContent=fmt(cap)+' deployed';
  document.getElementById('stat-roi-val').textContent=fmtPct(avgROI);
  document.querySelectorAll('.hero-stat').forEach(s=>s.classList.add('loaded'));
  document.getElementById('dash-inv-body').innerHTML=inventory.slice(0,6).map(w=>{
    const b=costBasis(w),d=daysHeld(w.purchase_date);
    const pc=d!==null?d+'d':'‚Äî',pillCls=d>60?'warn':d>30?'':'ok';
    return`<tr><td><div class="brand-badge">${w.brand||'?'}</div><div style="font-size:0.8rem;margin-top:0.3rem">${w.model||''}</div></td><td>${fmt(b)}</td><td>${w.listed_price?fmt(w.listed_price):'‚Äî'}</td><td><span class="days-pill ${pillCls}">${pc}</span></td></tr>`;
  }).join('');
  const bmap={};soldWatches.forEach(s=>{const b=s.brand||'Unknown';bmap[b]=(bmap[b]||0)+soldNetProfit(s);});
  const sorted=Object.entries(bmap).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const max=sorted.length?Math.max(...sorted.map(e=>Math.abs(e[1]))):1;
  document.getElementById('dash-brand-bars').innerHTML=sorted.map(([brand,profit])=>
    `<div class="brand-row"><div class="brand-name">${brand}</div><div class="brand-bar-wrap"><div class="brand-bar" style="width:${Math.abs(profit)/max*100}%"></div></div><div class="brand-profit">${fmt(profit)}</div></div>`
  ).join('');
}

// ‚îÄ‚îÄ INVENTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderInventory(){
  const q=(document.getElementById('inv-search').value||'').toLowerCase();
  const sort=document.getElementById('inv-sort').value;
  let f=inventory.filter(w=>`${w.brand} ${w.model} ${w.ref} ${w.serial}`.toLowerCase().includes(q));
  f.sort((a,b)=>{
    const ba=costBasis(a),bb=costBasis(b);
    if(sort==='date-asc')return new Date(a.created_at||0)-new Date(b.created_at||0);
    if(sort==='cost-desc')return bb-ba;if(sort==='cost-asc')return ba-bb;
    if(sort==='days-desc'){const da=daysHeld(a.purchase_date)||0,db2=daysHeld(b.purchase_date)||0;return db2-da;}
    return new Date(b.created_at||0)-new Date(a.created_at||0);
  });
  const cap=inventory.reduce((s,w)=>s+costBasis(w),0);
  document.getElementById('inv-subtitle').textContent=`${inventory.length} watches ¬∑ ${fmt(cap)} capital`;
  const grid=document.getElementById('inventory-grid'),empty=document.getElementById('inv-empty');
  const hdr=`<div class="inv-row-header"><span>Watch / Stage</span><span>Cost Basis</span><span>MSRP</span><span>Listed At</span><span>Potential Profit</span><span>Days Held</span><span>Platform</span></div>`;
  if(!f.length){grid.innerHTML=hdr;empty.style.display='block';return;}
  empty.style.display='none';
  grid.innerHTML=hdr+f.map(w=>{
    const b=costBasis(w),d=daysHeld(w.purchase_date);
    const profit=w.listed_price?w.listed_price-b:null;
    const pillCls=d>60?'warn':d>30?'':'ok';
    const sub=[w.ref,w.serial?'SN:'+w.serial:'',w.dial_color,w.case_size].filter(Boolean).join(' ¬∑ ');
    const plat=Array.isArray(w.platform)?w.platform.join(', '):(w.platform||'‚Äî');
    const si=w.stage_index!=null?w.stage_index:null;
    const stageBadge=si!=null?`<div style="margin-top:0.4rem"><span class="stage-badge stage-${si}"><span class="stage-dot"></span>${STAGES[si]}</span></div>`:'';
    return`<div class="inv-row" onclick="editWatch('${w.id}')">
      <div><div class="inv-row-brand">${w.brand||''}${w.year?' ¬∑ '+w.year:''}</div><div class="inv-row-model">${w.model||''}</div><div class="inv-row-sub">${sub||'‚Äî'}</div>${stageBadge}</div>
      <div class="inv-row-val gold">${fmt(b)}</div>
      <div class="inv-row-val muted">${w.msrp?fmt(w.msrp):'‚Äî'}</div>
      <div class="inv-row-val">${w.listed_price?fmt(w.listed_price):'‚Äî'}</div>
      <div class="inv-row-val ${profit!=null?(profit>=0?'green':'red'):'muted'}">${profit!=null?fmt(profit):'‚Äî'}</div>
      <div class="inv-row-val"><span class="days-pill ${pillCls}">${d!==null?d+'d':'‚Äî'}</span></div>
      <div class="inv-row-val muted">${plat}</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ SOLD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setSoldSort(v){document.getElementById('sold-sort').value=v;renderSold();}
function renderSold(){
  const q=(document.getElementById('sold-search').value||'').toLowerCase();
  const sort=document.getElementById('sold-sort').value;
  let f=soldWatches.filter(s=>`${s.brand} ${s.model} ${s.ref}`.toLowerCase().includes(q));
  f.sort((a,b)=>{
    if(sort==='profit-desc')return soldNetProfit(b)-soldNetProfit(a);
    if(sort==='profit-asc')return soldNetProfit(a)-soldNetProfit(b);
    if(sort==='roi-desc')return soldROI(b)-soldROI(a);
    return new Date(b.sale_date||0)-new Date(a.sale_date||0);
  });
  const tot=soldWatches.reduce((s,w)=>s+soldNetProfit(w),0);
  document.getElementById('sold-subtitle').textContent=`${soldWatches.length} sold ¬∑ ${fmt(tot)} profit`;
  const tbody=document.getElementById('sold-body'),empty=document.getElementById('sold-empty');
  if(!f.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=f.map(s=>{
    const p=soldNetProfit(s),r=soldROI(s),d=daysHeld(s.purchase_date,s.sale_date);
    const ppd=d&&d>0?p/d:null,hp=s.photo_urls&&s.photo_urls.length>0;
    return`<tr onclick="openSoldPhotoModal('${s.id}')" title="Click to add/edit photos">
      <td><div style="font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--gold);margin-bottom:0.2rem">${s.brand||''}</div><div style="font-size:0.76rem">${s.model||''}</div></td>
      <td style="color:var(--text2);font-size:0.7rem">${[s.ref,s.serial?'SN:'+s.serial:''].filter(Boolean).join(' ¬∑ ')||'‚Äî'}</td>
      <td>${fmt(soldCostBasis(s))}</td><td>${fmt(s.sold_price)}</td>
      <td style="font-size:0.68rem;color:var(--text2)">${Array.isArray(s.platform)?s.platform.join(', '):(s.platform||'‚Äî')}</td>
      <td><span class="profit-badge ${p>=0?'pos':'neg'}">${p>=0?'+':''}${fmt(p)}</span></td>
      <td style="color:${r>=0?'var(--green)':'var(--red)'}">${fmtPct(r)}</td>
      <td style="color:var(--text2)">${d!==null?d+'d':'‚Äî'}</td>
      <td style="color:var(--text2);font-size:0.68rem">${ppd!==null?(ppd>=0?'+':'')+fmt(ppd,2):'‚Äî'}</td>
      <td style="font-size:0.7rem;cursor:pointer" onclick="event.stopPropagation();openSoldPhotoModal('${s.id}')">${hp?'üì∑'+s.photo_urls.length:'<span style="color:var(--text2)">+üì∑</span>'}</td>
      <td>
        <button class="btn-outline btn-sm" style="white-space:nowrap;font-size:0.6rem" onclick="event.stopPropagation();openSoldEditModal('${s.id}')">‚úèÔ∏è Edit</button>
        <button class="btn-outline btn-sm" style="white-space:nowrap;font-size:0.6rem;margin-top:0.2rem" onclick="event.stopPropagation();unsellWatch('${s.id}')" title="Move back to inventory">‚Ü© Unsell</button>
      </td>
    </tr>`;
  }).join('');
}

// ‚îÄ‚îÄ CONTACTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateContactDropdowns(){
  const opts='<option value="">‚Äî None ‚Äî</option>'+contacts.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('f-contact-link').innerHTML=opts;
  const iOpts='<option value="">‚Äî Manual entry ‚Äî</option>'+contacts.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('inv-contact-select').innerHTML=iOpts;
}

function renderContacts(){
  const q=(document.getElementById('contact-search').value||'').toLowerCase();
  const f=contacts.filter(c=>`${c.name} ${c.email||''} ${c.phone||''}`.toLowerCase().includes(q));
  document.getElementById('contacts-subtitle').textContent=`${contacts.length} contacts`;
  const grid=document.getElementById('contacts-grid'),empty=document.getElementById('contacts-empty');
  if(!f.length){grid.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  grid.innerHTML=f.map(c=>{
    const bought=inventory.filter(w=>w.contact_id===c.id);
    const sold2=soldWatches.filter(w=>w.contact_id===c.id);
    const isBuyer=sold2.length>0,isSeller=bought.length>0;
    const tag=isBuyer&&isSeller?'both':isBuyer?'buyer':isSeller?'seller':'';
    const tagLabel=tag==='both'?'Buyer & Seller':tag==='buyer'?'Buyer':tag==='seller'?'Seller':'';
    const totalBought=bought.reduce((s,w)=>s+costBasis(w),0);
    const totalSold=sold2.reduce((s,w)=>s+(+w.sold_price||0),0);
    const cinvoices=invoices.filter(i=>i.contact_id===c.id);
    return`<div class="contact-card-item" onclick="showContactDetail('${c.id}')">
      <div style="display:flex;justify-content:space-between;align-items:start">
        <div class="contact-card-name">${c.name}</div>
        ${tag?`<span class="contact-tag ${tag}">${tagLabel}</span>`:''}
      </div>
      <div class="contact-card-info">${[c.phone,c.email,[c.city,c.state].filter(Boolean).join(' ')].filter(Boolean).join('<br>')}</div>
      <div class="contact-card-stats">
        <div class="contact-stat"><div class="contact-stat-val">${bought.length+sold2.length}</div><div class="contact-stat-label">Transactions</div></div>
        ${totalBought?`<div class="contact-stat"><div class="contact-stat-val" style="font-size:0.85rem">${fmt(totalBought)}</div><div class="contact-stat-label">Bought From</div></div>`:''}
        ${totalSold?`<div class="contact-stat"><div class="contact-stat-val" style="font-size:0.85rem">${fmt(totalSold)}</div><div class="contact-stat-label">Sold To</div></div>`:''}
        ${cinvoices.length?`<div class="contact-stat"><div class="contact-stat-val">${cinvoices.length}</div><div class="contact-stat-label">Invoices</div></div>`:''}
      </div>
      <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
        <button class="btn-outline btn-sm" onclick="event.stopPropagation();editContactModal('${c.id}')">Edit</button>
        <button class="btn-dark btn-sm" onclick="event.stopPropagation();newInvoiceForContact('${c.id}')">+ Invoice</button>
      </div>
    </div>`;
  }).join('');
}

function showContactDetail(id){
  const c=contacts.find(x=>x.id===id);if(!c)return;
  document.getElementById('contacts-list-view').style.display='none';
  document.getElementById('contacts-detail-view').style.display='block';
  const bought=inventory.filter(w=>w.contact_id===id);
  const sold2=soldWatches.filter(w=>w.contact_id===id);
  const cinvoices=invoices.filter(i=>i.contact_id===id);
  document.getElementById('contact-detail-content').innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem">
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:2rem;font-weight:400">${c.name}</div>
        <div style="font-size:0.8rem;color:var(--text2);margin-top:0.25rem;line-height:1.8">${[c.phone,c.email,c.address,[c.city,c.state].filter(Boolean).join(' ')].filter(Boolean).join(' ¬∑ ')}</div>
        ${c.notes?`<div style="margin-top:0.75rem;font-size:0.75rem;color:var(--text2);background:var(--surface2);padding:0.75rem;border-left:3px solid var(--gold)">${c.notes}</div>`:''}
      </div>
      <div style="display:flex;gap:0.5rem">
        <button class="btn-outline btn-sm" onclick="editContactModal('${id}')">Edit Contact</button>
        <button class="btn-gold btn-sm" onclick="newInvoiceForContact('${id}')">+ New Invoice</button>
      </div>
    </div>
    ${bought.length?`<div class="panel-title" style="margin-bottom:0.75rem">Watches Purchased From (${bought.length})</div>${bought.map(w=>`<div class="contact-history-item"><div><div style="font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--gold)">${w.brand}</div><div style="font-size:0.85rem">${w.model}${w.ref?' ¬∑ '+w.ref:''}${w.serial?' ¬∑ SN:'+w.serial:''}</div></div><span class="contact-history-type bought">Source</span><div style="font-size:0.85rem;color:var(--gold)">${fmt(costBasis(w))}</div></div>`).join('')}`:''}
    ${sold2.length?`<div class="panel-title" style="margin:1.5rem 0 0.75rem">Watches Sold To (${sold2.length})</div>${sold2.map(s=>`<div class="contact-history-item"><div><div style="font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--gold)">${s.brand}</div><div style="font-size:0.85rem">${s.model}${s.ref?' ¬∑ '+s.ref:''}${s.serial?' ¬∑ SN:'+s.serial:''}</div></div><span class="contact-history-type sold-to">Buyer</span><div><div style="font-size:0.85rem">${fmt(s.sold_price)}</div><div style="font-size:0.7rem;color:${soldNetProfit(s)>=0?'var(--green)':'var(--red)'}">${fmt(soldNetProfit(s))} profit</div></div></div>`).join('')}`:''}
    ${cinvoices.length?`<div class="panel-title" style="margin:1.5rem 0 0.75rem">Invoices (${cinvoices.length})</div>${cinvoices.map(i=>`<div class="contact-history-item" onclick="viewInvoice('${i.id}')" style="cursor:pointer"><div><div style="font-size:0.75rem;font-weight:600">Invoice #${i.invoice_number||'‚Äî'}</div><div style="font-size:0.7rem;color:var(--text2)">${i.invoice_date||''}</div></div><span class="invoice-status ${i.status||'unpaid'}">${i.status||'Unpaid'}</span><div style="font-family:'Playfair Display',serif;font-size:1rem">${fmt(i.total)}</div></div>`).join('')}`:''}
    ${!bought.length&&!sold2.length&&!cinvoices.length?`<div class="empty-state"><p>No transactions yet for this contact.</p></div>`:''}
  `;
}

function showContactsList(){document.getElementById('contacts-list-view').style.display='';document.getElementById('contacts-detail-view').style.display='none';}

function openContactModal(){
  editingContactId=null;
  document.getElementById('contact-modal-title').textContent='Add Contact';
  document.getElementById('cf-delete-btn').style.display='none';
  ['cf-name','cf-phone','cf-email','cf-address','cf-city','cf-state','cf-notes'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('contact-modal').classList.add('open');
}
function editContactModal(id){
  const c=contacts.find(x=>x.id===id);if(!c)return;
  editingContactId=id;
  document.getElementById('contact-modal-title').textContent='Edit Contact';
  document.getElementById('cf-delete-btn').style.display='inline-block';
  document.getElementById('cf-name').value=c.name||'';
  document.getElementById('cf-phone').value=c.phone||'';
  document.getElementById('cf-email').value=c.email||'';
  document.getElementById('cf-address').value=c.address||'';
  document.getElementById('cf-city').value=c.city||'';
  document.getElementById('cf-state').value=c.state||'';
  document.getElementById('cf-notes').value=c.notes||'';
  document.getElementById('contact-modal').classList.add('open');
}
function closeContactModal(){document.getElementById('contact-modal').classList.remove('open');}
async function saveContact(){
  const name=document.getElementById('cf-name').value.trim();
  if(!name){showToast('Name is required.');return;}
  const row={user_id:currentUser.id,name,phone:document.getElementById('cf-phone').value.trim()||null,email:document.getElementById('cf-email').value.trim()||null,address:document.getElementById('cf-address').value.trim()||null,city:document.getElementById('cf-city').value.trim()||null,state:document.getElementById('cf-state').value.trim()||null,notes:document.getElementById('cf-notes').value.trim()||null};
  if(editingContactId){
    const{error}=await db.from('contacts').update(row).eq('id',editingContactId);
    if(error){showToast('Error: '+error.message);return;}
    contacts=contacts.map(c=>c.id===editingContactId?{...c,...row,id:editingContactId}:c);
  }else{
    const{data,error}=await db.from('contacts').insert(row).select().single();
    if(error){showToast('Error: '+error.message);return;}
    contacts.unshift(data);
  }
  closeContactModal();populateContactDropdowns();renderContacts();updateNavBadges();
  showToast(editingContactId?'Contact updated.':'Contact added.');
}
async function deleteContact(){
  if(!editingContactId)return;
  if(!confirm('Delete this contact? Transaction history will remain.'))return;
  const{error}=await db.from('contacts').delete().eq('id',editingContactId);
  if(error){showToast('Error: '+error.message);return;}
  contacts=contacts.filter(c=>c.id!==editingContactId);
  closeContactModal();renderContacts();updateNavBadges();showToast('Contact deleted.');
}

// ‚îÄ‚îÄ INVOICES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderInvoices(){
  document.getElementById('invoices-subtitle').textContent=`${invoices.length} sent ¬∑ ${receivedInvoices.length} received`;
  const list=document.getElementById('invoice-list'),empty=document.getElementById('invoices-empty');
  if(!invoices.length){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  list.innerHTML=invoices.map(inv=>`
    <div class="invoice-item" onclick="viewInvoice('${inv.id}')">
      <div class="invoice-num">#${inv.invoice_number||'‚Äî'}</div>
      <div><div class="invoice-client">${inv.bill_name||'‚Äî'}</div><div class="invoice-desc">${inv.invoice_date||''}</div></div>
      <div></div>
      <div class="invoice-amount">${fmt(inv.total)}</div>
      <span class="invoice-status ${inv.status||'unpaid'}">${capitalize(inv.status||'unpaid')}</span>
    </div>`).join('');
}
function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1);}
function showInvoicesList(){document.getElementById('invoices-list-view').style.display='';document.getElementById('invoices-detail-view').style.display='none';}

function openInvoiceModal(contactId){
  editingInvoiceId=null;invoiceLineItems=[];
  document.getElementById('invoice-modal-title').textContent='New Invoice';
  populateContactDropdowns();
  // Auto-increment invoice number
  let nextNum='26-001';
  if(invoices.length){
    const last=invoices[0].invoice_number||'';
    const m=last.match(/^(\d+)-(\d+)$/);
    if(m)nextNum=m[1]+'-'+(String(parseInt(m[2])+1).padStart(String(m[2]).length,'0'));
    else nextNum=last;
  }
  document.getElementById('inv-number').value=nextNum;
  const today=new Date().toISOString().split('T')[0];
  document.getElementById('inv-date').value=today;
  document.getElementById('inv-due-date').value=today;
  document.getElementById('inv-deposit').value='';
  document.getElementById('inv-notes').value='';
  ['inv-bill-name','inv-bill-address','inv-bill-city','inv-bill-phone','inv-bill-email'].forEach(id=>document.getElementById(id).value='');
  ['inv-show-zelle','inv-show-apple','inv-show-wire'].forEach(id=>document.getElementById(id).checked=false);
  document.getElementById('inv-contact-select').value='';
  if(contactId){document.getElementById('inv-contact-select').value=contactId;fillInvoiceContact();}
  renderInvoiceLines();updateInvoiceTotals();
  document.getElementById('invoice-modal').classList.add('open');
}
function closeInvoiceModal(){document.getElementById('invoice-modal').classList.remove('open');}
function newInvoiceForContact(contactId){showPage('invoices');setTimeout(()=>openInvoiceModal(contactId),50);}

function fillInvoiceContact(){
  const id=document.getElementById('inv-contact-select').value;if(!id)return;
  const c=contacts.find(x=>x.id===id);if(!c)return;
  document.getElementById('inv-bill-name').value=c.name||'';
  document.getElementById('inv-bill-phone').value=c.phone||'';
  document.getElementById('inv-bill-email').value=c.email||'';
  document.getElementById('inv-bill-address').value=c.address||'';
  document.getElementById('inv-bill-city').value=[c.city,c.state].filter(Boolean).join(', ');
}

function addInvoiceLineManual(){
  invoiceLineItems.push({type:'manual',description:'',qty:1,price:0,watchId:null});
  renderInvoiceLines();
}
function addInvoiceLineFromInventory(){document.getElementById('inv-picker-modal').classList.add('open');renderInvPicker();}
function closeInvPicker(){document.getElementById('inv-picker-modal').classList.remove('open');}
function renderInvPicker(){
  const q=(document.getElementById('inv-picker-search').value||'').toLowerCase();
  const f=inventory.filter(w=>`${w.brand} ${w.model} ${w.ref} ${w.serial||''}`.toLowerCase().includes(q));
  document.getElementById('inv-picker-list').innerHTML=f.length?f.map(w=>
    `<div style="padding:0.85rem 1rem;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.1s" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''" onclick="pickWatchForInvoice('${w.id}')">
      <div style="font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--gold);margin-bottom:0.2rem">${w.brand}</div>
      <div style="font-size:0.88rem;font-weight:500">${w.model}${w.ref?' ¬∑ Ref: '+w.ref:''}${w.serial?' ¬∑ SN: '+w.serial:''}</div>
      <div style="font-size:0.7rem;color:var(--text2);margin-top:0.15rem">${w.year?'Year: '+w.year+' ¬∑ ':''} Listed: ${w.listed_price?fmt(w.listed_price):'No price set'} ¬∑ ${w.condition||''} ${w.box_papers?'¬∑ '+w.box_papers:''}</div>
    </div>`).join(''):'<div style="padding:1.5rem;text-align:center;color:var(--text2);font-size:0.75rem">No inventory matches</div>';
}
function pickWatchForInvoice(watchId){
  const w=inventory.find(x=>x.id===watchId);if(!w)return;
  const parts=[w.brand,w.model];
  if(w.ref)parts.push('Ref: '+w.ref);
  if(w.year)parts.push('Year: '+w.year);
  if(w.serial)parts.push('SN: '+w.serial);
  if(w.condition)parts.push(w.condition);
  if(w.box_papers)parts.push(w.box_papers);
  invoiceLineItems.push({type:'watch',description:parts.join(' ¬∑ '),qty:1,price:w.listed_price||0,watchId:w.id});
  closeInvPicker();renderInvoiceLines();updateInvoiceTotals();
}
function renderInvoiceLines(){
  const c=document.getElementById('inv-line-items');
  if(!invoiceLineItems.length){c.innerHTML=`<div style="text-align:center;padding:1.5rem;border:1px dashed var(--border);color:var(--text2);font-size:0.75rem;margin-bottom:0.75rem">No items yet ‚Äî add from inventory or manually</div>`;return;}
  c.innerHTML=invoiceLineItems.map((item,i)=>`
    <div style="display:grid;grid-template-columns:1fr 80px 130px auto;gap:0.5rem;align-items:center;margin-bottom:0.5rem;padding:0.5rem;background:var(--surface2);border:1px solid var(--border)">
      <input class="form-input" value="${escHtml(item.description)}" placeholder="Description" oninput="invoiceLineItems[${i}].description=this.value" style="font-size:0.75rem">
      <input class="form-input" type="number" value="${item.qty}" min="1" oninput="invoiceLineItems[${i}].qty=+this.value;updateInvoiceTotals()" style="font-size:0.75rem">
      <input class="form-input" type="number" value="${item.price}" placeholder="Price" oninput="invoiceLineItems[${i}].price=+this.value;updateInvoiceTotals()" style="font-size:0.75rem">
      <button onclick="removeInvoiceLine(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:1.1rem;padding:0 0.25rem;line-height:1">‚úï</button>
    </div>`).join('');
}
function escHtml(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function removeInvoiceLine(i){invoiceLineItems.splice(i,1);renderInvoiceLines();updateInvoiceTotals();}
function updateInvoiceTotals(){
  const sub=invoiceLineItems.reduce((s,item)=>s+(+item.price||0)*(+item.qty||1),0);
  const dep=parseFloat(document.getElementById('inv-deposit').value)||0;
  document.getElementById('inv-preview-subtotal').textContent=fmt(sub);
  document.getElementById('inv-preview-balance').textContent=fmt(sub-dep);
  if(dep>0){document.getElementById('inv-deposit-row').style.display='flex';document.getElementById('inv-preview-deposit').textContent='-'+fmt(dep);}
  else document.getElementById('inv-deposit-row').style.display='none';
}

async function saveInvoice(){
  const billName=document.getElementById('inv-bill-name').value.trim();
  if(!billName){showToast('Buyer name is required.');return;}
  if(!invoiceLineItems.length){showToast('Add at least one item.');return;}
  const sub=invoiceLineItems.reduce((s,item)=>s+(+item.price||0)*(+item.qty||1),0);
  const dep=parseFloat(document.getElementById('inv-deposit').value)||0;
  const contactId=document.getElementById('inv-contact-select').value||null;
  const status=dep>=sub&&sub>0?'paid':dep>0?'partial':'unpaid';
  const row={
    user_id:currentUser.id,contact_id:contactId,
    invoice_number:document.getElementById('inv-number').value.trim(),
    invoice_date:document.getElementById('inv-date').value,
    due_date:document.getElementById('inv-due-date').value,
    bill_name:billName,
    bill_address:document.getElementById('inv-bill-address').value.trim()||null,
    bill_city:document.getElementById('inv-bill-city').value.trim()||null,
    bill_phone:document.getElementById('inv-bill-phone').value.trim()||null,
    bill_email:document.getElementById('inv-bill-email').value.trim()||null,
    line_items:invoiceLineItems,
    subtotal:sub,deposit:dep,total:sub,balance_due:sub-dep,
    notes:document.getElementById('inv-notes').value.trim()||null,
    show_zelle:document.getElementById('inv-show-zelle').checked,
    show_applepay:document.getElementById('inv-show-apple').checked,
    show_wire:document.getElementById('inv-show-wire').checked,
    status,
  };
  let savedId;
  if(editingInvoiceId){
    const{error}=await db.from('invoices').update(row).eq('id',editingInvoiceId);
    if(error){showToast('Error: '+error.message);return;}
    invoices=invoices.map(i=>i.id===editingInvoiceId?{...i,...row,id:editingInvoiceId}:i);
    savedId=editingInvoiceId;
  }else{
    const{data,error}=await db.from('invoices').insert(row).select().single();
    if(error){showToast('Error: '+error.message);return;}
    invoices.unshift(data);savedId=data.id;
  }
  closeInvoiceModal();updateNavBadges();
  showPage('invoices');setTimeout(()=>viewInvoice(savedId),50);
}

function viewInvoice(id){
  const inv=invoices.find(x=>x.id===id);if(!inv)return;
  currentInvoiceData=inv;
  showPage('invoices');
  document.getElementById('invoices-list-view').style.display='none';
  document.getElementById('invoices-detail-view').style.display='block';
  document.getElementById('btn-mark-paid').style.display=inv.status==='paid'?'none':'inline-block';
  document.getElementById('invoice-detail-content').innerHTML=buildInvoiceHTML(inv);
}

function editCurrentInvoice(){
  if(!currentInvoiceData)return;
  const inv=currentInvoiceData;
  editingInvoiceId=inv.id;
  invoiceLineItems=JSON.parse(JSON.stringify(inv.line_items||[]));
  populateContactDropdowns();
  document.getElementById('invoice-modal-title').textContent='Edit Invoice';
  document.getElementById('inv-number').value=inv.invoice_number||'';
  document.getElementById('inv-date').value=inv.invoice_date||'';
  document.getElementById('inv-due-date').value=inv.due_date||'';
  document.getElementById('inv-bill-name').value=inv.bill_name||'';
  document.getElementById('inv-bill-address').value=inv.bill_address||'';
  document.getElementById('inv-bill-city').value=inv.bill_city||'';
  document.getElementById('inv-bill-phone').value=inv.bill_phone||'';
  document.getElementById('inv-bill-email').value=inv.bill_email||'';
  document.getElementById('inv-deposit').value=inv.deposit||'';
  document.getElementById('inv-notes').value=inv.notes||'';
  document.getElementById('inv-contact-select').value=inv.contact_id||'';
  document.getElementById('inv-show-zelle').checked=inv.show_zelle||false;
  document.getElementById('inv-show-apple').checked=inv.show_applepay||false;
  document.getElementById('inv-show-wire').checked=inv.show_wire||false;
  renderInvoiceLines();updateInvoiceTotals();
  document.getElementById('invoice-modal').classList.add('open');
}

async function markInvoicePaid(){
  if(!currentInvoiceData)return;
  const{error}=await db.from('invoices').update({status:'paid'}).eq('id',currentInvoiceData.id);
  if(error){showToast('Error: '+error.message);return;}
  invoices=invoices.map(i=>i.id===currentInvoiceData.id?{...i,status:'paid'}:i);
  currentInvoiceData={...currentInvoiceData,status:'paid'};
  document.getElementById('btn-mark-paid').style.display='none';
  document.getElementById('invoice-detail-content').innerHTML=buildInvoiceHTML(currentInvoiceData);
  showToast('Invoice marked as paid.');
}

function printInvoice(){window.print();}

function buildInvoiceHTML(inv){
  const items=inv.line_items||[];
  const logoHtml=`<div style="width:80px;height:94px;display:flex;align-items:center;justify-content:center">${LOGO_SVG.replace(/width="600"/, 'width="80"').replace(/height="700"/, 'height="94"')}</div>`;
  return`<div class="invoice-preview">
    <div class="inv-hdr">
      <div>
        <div class="inv-biz-name">${BIZ_NAME}</div>
        <div class="inv-biz-info">${BIZ_ADDRESS}<br>${BIZ_EMAIL}<br>${BIZ_PHONE}</div>
      </div>
      <div class="inv-logo-area" id="inv-logo-area">${logoHtml}</div>
      <div class="inv-title-block">
        <div class="inv-title">Invoice</div>
        <div class="inv-meta-row"><strong>Invoice No:</strong>${inv.invoice_number||'‚Äî'}</div>
        <div class="inv-meta-row"><strong>Date:</strong>${inv.invoice_date||'‚Äî'}</div>
        <div class="inv-meta-row"><strong>Due Date:</strong>${inv.due_date||inv.invoice_date||'‚Äî'}</div>
      </div>
    </div>
    <div class="inv-bill-section">
      <div class="inv-bill-label">Bill To</div>
      <div class="inv-bill-name">${inv.bill_name||'‚Äî'}</div>
      <div class="inv-bill-info">${[inv.bill_email,inv.bill_address,inv.bill_city,inv.bill_phone].filter(Boolean).join('<br>')}</div>
    </div>
    <table class="inv-table">
      <thead><tr><th>Description</th><th class="right">Qty</th><th class="right">Rate</th><th class="right">Amount</th></tr></thead>
      <tbody>
        ${items.map(item=>`<tr>
          <td>${escHtml(item.description||'‚Äî')}<span class="non-tax">*Non-taxable item</span></td>
          <td class="right">${item.qty||1}</td>
          <td class="right">${fmt(item.price)}</td>
          <td class="right">${fmt((+item.price||0)*(+item.qty||1))}*</td>
        </tr>`).join('')}
      </tbody>
    </table>
    ${inv.notes?`<div class="inv-notes-box">${escHtml(inv.notes)}</div>`:''}
    <div class="inv-bottom">
      ${showPay?`<div class="inv-payment-box">
        <h4>Payment Instructions</h4>
        <p>
          ${inv.show_zelle?`Zelle: ${PAY_ZELLE}<br>`:''}
          ${inv.show_applepay?`Apple Pay: ${PAY_APPLEPAY}<br>`:''}
          ${inv.show_wire?`<br><strong>Wire Transfer (US &amp; International)</strong><br>${WIRE_BANK}<br>${WIRE_NAME}<br>${WIRE_ADDRESS}<br>Account Number: ${WIRE_ACCOUNT}<br>Domestic Wire Routing: ${WIRE_ROUTING}`:''}
        </p>
      </div>`:'<div></div>'}
      <div>
        <div class="inv-total-row subtotal"><span>Subtotal</span><span>${fmt(inv.subtotal)}</span></div>
        <div class="inv-total-row grand"><span>Total</span><span>${fmt(inv.total)}</span></div>
        ${inv.deposit?`<div class="inv-total-row deposit-line"><span>Deposit Received</span><span>‚Äì${fmt(inv.deposit)}</span></div>`:''}
        <div class="inv-total-row"><span>Paid</span><span>${fmt(inv.deposit||0)}</span></div>
        <div class="inv-balance-bar"><span>Balance Due</span><span>${fmt(inv.balance_due)}</span></div>
      </div>
    </div>
    <div class="inv-footer-note">Thank you for your business ¬∑ ${BIZ_NAME}</div>
  </div>`;
}

// ‚îÄ‚îÄ WATCH MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab){
  document.querySelectorAll('.modal-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.modal-tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelector(`.modal-tab[onclick="switchTab('${tab}')"]`).classList.add('active');
  document.getElementById('tab-'+tab).classList.add('active');
}
function openModal(){
  editingId=null;
  document.getElementById('modal-title').textContent='Add Watch to Inventory';
  document.getElementById('btn-delete').style.display='none';
  document.getElementById('tab-sell-btn').style.display='none';
  clearWatchForm();pendingPhotos=[];renderPhotoGrid();
  buildSwatches('dial-colors',DIAL_COLORS,'f-dial-color');
  buildSwatches('bezel-colors',BEZEL_COLORS,'f-bezel-color');
  populateContactDropdowns();
  buildStageSelector(0);
  switchTab('basics');
  document.getElementById('modal').classList.add('open');
  setTimeout(()=>document.getElementById('f-brand').focus(),50);
}
function editWatch(id){
  const w=inventory.find(x=>x.id===id);if(!w)return;
  editingId=id;
  document.getElementById('modal-title').textContent='Edit Watch';
  document.getElementById('btn-delete').style.display='inline-block';
  document.getElementById('tab-sell-btn').style.display='block';
  buildSwatches('dial-colors',DIAL_COLORS,'f-dial-color');
  buildSwatches('bezel-colors',BEZEL_COLORS,'f-bezel-color');
  populateContactDropdowns();
  buildStageSelector(w.stage_index!=null?w.stage_index:0);
  loadPhotosForEdit(w.photo_urls||[]);
  const fields={
    'f-brand':w.brand,'f-model':w.model,'f-ref':w.ref,'f-serial':w.serial,
    'f-year':w.year,'f-purchase-date':w.purchase_date,'f-purchase-price':w.purchase_price,
    'f-tax':w.tax,'f-shipping-in':w.shipping_in,'f-other-fees':w.other_fees,
    'f-listed-price':w.listed_price,'f-msrp':w.msrp,'f-notes':w.notes,'f-case-size':w.case_size,
    'f-dial-color':w.dial_color,'f-bezel-color':w.bezel_color,'f-bracelet-color':w.bracelet_color,
    'f-buy-name':w.buy_name,'f-buy-phone':w.buy_phone,'f-buy-email':w.buy_email,'f-buy-location':w.buy_location,
    'f-sell-name':w.sell_name,'f-sell-phone':w.sell_phone,'f-sell-email':w.sell_email,'f-sell-location':w.sell_location,
  };
  const selects={'f-platform':w.platform,'f-condition':w.condition,'f-box-papers':w.box_papers,'f-case-material':w.case_material,'f-movement':w.movement,'f-bracelet-type':w.bracelet_type,'f-contact-link':w.contact_id||''};
  Object.entries(fields).forEach(([id,val])=>{const el=document.getElementById(id);if(el)el.value=val||'';});
  Object.entries(selects).forEach(([id,val])=>{const el=document.getElementById(id);if(el)el.value=val||'';});
  setPlatforms('f-platform-checks',w.platform||[]);
  clearPlatforms('f-sale-platform-checks');
  if(w.dial_color)highlightSwatch('dial-colors',w.dial_color);
  if(w.bezel_color)highlightSwatch('bezel-colors',w.bezel_color);
  document.getElementById('f-sale-date').value=new Date().toISOString().split('T')[0];
  switchTab('basics');
  document.getElementById('modal').classList.add('open');
}
function clearWatchForm(){
  ['f-brand','f-model','f-ref','f-serial','f-year','f-purchase-date','f-purchase-price','f-tax','f-shipping-in','f-other-fees','f-listed-price','f-msrp','f-notes','f-case-size','f-dial-color','f-bezel-color','f-bracelet-color','f-buy-name','f-buy-phone','f-buy-email','f-buy-location','f-sell-name','f-sell-phone','f-sell-email','f-sell-location','f-sell-name-sell','f-sell-phone-sell','f-sell-email-sell','f-sold-price','f-platform-fee','f-payment-fee','f-shipping-out','f-sale-date'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  ['f-condition','f-box-papers','f-case-material','f-movement','f-bracelet-type','f-contact-link'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  clearPlatforms('f-platform-checks');clearPlatforms('f-sale-platform-checks');
  document.querySelectorAll('.color-chip').forEach(c=>c.classList.remove('selected'));
  document.getElementById('sell-pnl').textContent='Enter sold price above to see projected profit.';
  document.getElementById('sell-pnl').style.color='var(--text2)';
}
function closeModal(){document.getElementById('modal').classList.remove('open');}
function closeModalOverlay(e){if(e.target===document.getElementById('modal'))closeModal();}

function updateSellPnL(){
  const w=inventory.find(x=>x.id===editingId);if(!w)return;
  const b=costBasis(w),sp=parseFloat(document.getElementById('f-sold-price').value)||0;
  const pf=parseFloat(document.getElementById('f-platform-fee').value)||0;
  const payf=parseFloat(document.getElementById('f-payment-fee').value)||0;
  const ship=parseFloat(document.getElementById('f-shipping-out').value)||0;
  const profit=sp-pf-payf-ship-b,roi=b?profit/b*100:0;
  const el=document.getElementById('sell-pnl');
  el.innerHTML=`<span style="color:${profit>=0?'var(--green)':'var(--red)'}">Profit: ${fmt(profit)} (${fmtPct(roi)})</span> <span style="color:var(--text2);font-size:0.72rem">¬∑ Cost basis: ${fmt(b)}</span>`;
}

const STAGES=[
  'Purchased ‚Äî Awaiting Payment',
  'Paid ‚Äî Shipping to Me',
  'In Hand ‚Äî Cleaning / Service',
  'Photography / Prep for Listing',
  'Listed ‚Äî Active on Platforms',
  'Offer Accepted ‚Äî Pending Auth',
  'Authentication ‚Äî Shipped to Auth',
  'Awaiting Payment from Buyer',
  'Shipped to Buyer',
  'Closed / Complete',
];
const STAGE_ICONS=['üí≥','üì¶','üîß','üì∏','üè∑Ô∏è','ü§ù','üîç','‚è≥','üöö','‚úÖ'];

function buildStageSelector(selectedIdx){
  const el=document.getElementById('f-stage-selector');if(!el)return;
  el.innerHTML=STAGES.map((s,i)=>`
    <div class="stage-option${selectedIdx===i?' selected':''}" onclick="selectStage(${i})">
      <span class="stage-badge stage-${i}" style="flex-shrink:0"><span class="stage-dot"></span></span>
      <span class="stage-option-num">${i+1}.</span>
      <span>${STAGE_ICONS[i]} ${s}</span>
    </div>`).join('');
}
function selectStage(idx){
  document.querySelectorAll('.stage-option').forEach((el,i)=>el.classList.toggle('selected',i===idx));
}
function getSelectedStage(){
  const el=document.querySelector('.stage-option.selected');
  if(!el)return null;
  return Array.from(document.querySelectorAll('.stage-option')).indexOf(el);
}

function getPlatforms(groupId){return Array.from(document.querySelectorAll(`#${groupId} .platform-check.selected`)).map(el=>el.dataset.val);}
function togglePlatform(el){el.classList.toggle('selected');}
function setPlatforms(groupId,values){
  const arr=Array.isArray(values)?values:(values?[values]:[]);
  document.querySelectorAll(`#${groupId} .platform-check`).forEach(el=>{
    el.classList.toggle('selected',arr.includes(el.dataset.val));
  });
}
function clearPlatforms(groupId){document.querySelectorAll(`#${groupId} .platform-check`).forEach(el=>el.classList.remove('selected'));}

function getFormData(){
  const g=id=>document.getElementById(id);
  return{
    brand:g('f-brand').value.trim(),model:g('f-model').value.trim(),
    ref:g('f-ref').value.trim(),serial:g('f-serial').value.trim(),year:g('f-year').value.trim(),
    purchaseDate:g('f-purchase-date').value,
    purchasePrice:parseFloat(g('f-purchase-price').value)||0,
    tax:parseFloat(g('f-tax').value)||0,shippingIn:parseFloat(g('f-shipping-in').value)||0,
    otherFees:parseFloat(g('f-other-fees').value)||0,
    listedPrice:parseFloat(g('f-listed-price').value)||null,
    msrp:parseFloat(g('f-msrp').value)||null,
    platform:getPlatforms('f-platform-checks'),
    stageIndex:getSelectedStage(),
    notes:g('f-notes').value.trim(),
    contactId:g('f-contact-link').value||null,
    caseSize:g('f-case-size').value.trim(),caseMaterial:g('f-case-material').value,
    movement:g('f-movement').value,condition:g('f-condition').value,boxPapers:g('f-box-papers').value,
    dialColor:g('f-dial-color').value.trim(),bezelColor:g('f-bezel-color').value.trim(),
    braceletType:g('f-bracelet-type').value,braceletColor:g('f-bracelet-color').value.trim(),
    buyName:g('f-buy-name').value.trim(),buyPhone:g('f-buy-phone').value.trim(),
    buyEmail:g('f-buy-email').value.trim(),buyLocation:g('f-buy-location').value.trim(),
    sellName:g('f-sell-name').value.trim(),sellPhone:g('f-sell-phone').value.trim(),
    sellEmail:g('f-sell-email').value.trim(),sellLocation:g('f-sell-location').value.trim(),
  };
}
function localToDb(d){
  return{
    user_id:currentUser.id,brand:d.brand,model:d.model,ref:d.ref||null,serial:d.serial||null,
    year:d.year||null,purchase_date:d.purchaseDate||null,purchase_price:d.purchasePrice||0,
    tax:d.tax||0,shipping_in:d.shippingIn||0,other_fees:d.otherFees||0,
    listed_price:d.listedPrice||null,msrp:d.msrp||null,
    platform:d.platform&&d.platform.length?d.platform:null,
    stage_index:d.stageIndex!=null?d.stageIndex:0,
    notes:d.notes||null,contact_id:d.contactId||null,
    case_size:d.caseSize||null,case_material:d.caseMaterial||null,
    movement:d.movement||null,condition:d.condition||null,box_papers:d.boxPapers||null,
    dial_color:d.dialColor||null,bezel_color:d.bezelColor||null,
    bracelet_type:d.braceletType||null,bracelet_color:d.braceletColor||null,
    buy_name:d.buyName||null,buy_phone:d.buyPhone||null,buy_email:d.buyEmail||null,buy_location:d.buyLocation||null,
    sell_name:d.sellName||null,sell_phone:d.sellPhone||null,sell_email:d.sellEmail||null,sell_location:d.sellLocation||null,
  };
}

async function saveWatch(){
  const data=getFormData();
  if(!data.brand||!data.model){showToast('Brand and Model are required.');switchTab('basics');return;}
  const btn=document.getElementById('btn-save');
  btn.disabled=true;btn.textContent='Saving...';
  const dbRow=localToDb(data);
  let error,savedId;
  if(editingId){
    const res=await db.from('inventory').update(dbRow).eq('id',editingId);
    error=res.error;savedId=editingId;
    if(!error){const i=inventory.findIndex(w=>w.id===editingId);inventory[i]={...inventory[i],...dbRow,id:editingId};}
  }else{
    const res=await db.from('inventory').insert(dbRow).select().single();
    error=res.error;if(!error){savedId=res.data.id;inventory.unshift(res.data);}
  }
  if(error){btn.disabled=false;btn.textContent='Save Watch';showToast('Error: '+error.message);return;}
  btn.textContent=pendingPhotos.some(p=>!p.existing)?'Uploading...':'Saving...';
  const photoUrls=await uploadPhotosForWatch(savedId);
  await db.from('inventory').update({photo_urls:photoUrls}).eq('id',savedId);
  const idx=inventory.findIndex(w=>w.id===savedId);if(idx!==-1)inventory[idx].photo_urls=photoUrls;
  btn.disabled=false;btn.textContent='Save Watch';
  closeModal();refreshAll();showToast(editingId?'Watch updated.':'Watch added.');
}

async function deleteWatch(){
  if(!editingId||!confirm('Delete this watch? This cannot be undone.'))return;
  const{error}=await db.from('inventory').delete().eq('id',editingId);
  if(error){showToast('Error: '+error.message);return;}
  inventory=inventory.filter(w=>w.id!==editingId);
  closeModal();refreshAll();showToast('Watch deleted.');
}

async function markAsSold(){
  if(!editingId)return;
  const row=inventory.find(w=>w.id===editingId);if(!row)return;
  const soldPrice=parseFloat(document.getElementById('f-sold-price').value)||0;
  if(!soldPrice){showToast('Enter a sold price.');return;}
  const g=id=>document.getElementById(id).value.trim();
  const sellName=g('f-sell-name-sell')||row.sell_name||'';
  const sellPhone=g('f-sell-phone-sell')||row.sell_phone||'';
  const sellEmail=g('f-sell-email-sell')||row.sell_email||'';
  // Auto-create contact
  let contactId=row.contact_id;
  if(sellName&&!contactId){
    const existing=contacts.find(c=>c.name.toLowerCase()===sellName.toLowerCase());
    if(existing){contactId=existing.id;}
    else{
      const{data:nc}=await db.from('contacts').insert({user_id:currentUser.id,name:sellName,phone:sellPhone||null,email:sellEmail||null}).select().single();
      if(nc){contacts.unshift(nc);contactId=nc.id;updateNavBadges();}
    }
  }
  const soldRow={
    user_id:currentUser.id,contact_id:contactId||null,
    brand:row.brand,model:row.model,ref:row.ref,year:row.year,serial:row.serial,
    purchase_date:row.purchase_date,
    sale_date:document.getElementById('f-sale-date').value||new Date().toISOString().split('T')[0],
    purchase_price:row.purchase_price,tax:row.tax,shipping_in:row.shipping_in,other_fees:row.other_fees,
    sold_price:soldPrice,
    platform_fee:parseFloat(document.getElementById('f-platform-fee').value)||0,
    payment_fee:parseFloat(document.getElementById('f-payment-fee').value)||0,
    shipping_out:parseFloat(document.getElementById('f-shipping-out').value)||0,
    platform:getPlatforms('f-sale-platform-checks').length?getPlatforms('f-sale-platform-checks'):row.platform,
    notes:row.notes,condition:row.condition,box_papers:row.box_papers,
    case_size:row.case_size,case_material:row.case_material,movement:row.movement,
    dial_color:row.dial_color,bezel_color:row.bezel_color,bracelet_type:row.bracelet_type,bracelet_color:row.bracelet_color,
    buy_name:row.buy_name,buy_phone:row.buy_phone,buy_email:row.buy_email,buy_location:row.buy_location,
    sell_name:sellName,sell_phone:sellPhone,sell_email:sellEmail,sell_location:row.sell_location||'',
    photo_urls:row.photo_urls||[],
  };
  const[ins,del]=await Promise.all([
    db.from('sold_inventory').insert(soldRow).select().single(),
    db.from('inventory').delete().eq('id',editingId)
  ]);
  if(ins.error){showToast('Error: '+ins.error.message);return;}
  soldWatches.unshift(ins.data);
  inventory=inventory.filter(w=>w.id!==editingId);
  const p=soldNetProfit(ins.data);
  closeModal();refreshAll();populateContactDropdowns();
  showToast(`${row.brand} ${row.model} sold ¬∑ Profit: ${fmt(p)}`);
}

function refreshAll(){renderDashboard();renderInventory();renderSold();updateNavBadges();}

// ‚îÄ‚îÄ SWATCHES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DIAL_COLORS=[{hex:'#1a1a1a',name:'Black'},{hex:'#2c3e6b',name:'Blue'},{hex:'#1e4d3b',name:'Green'},{hex:'#f5f0e8',name:'White/Cream'},{hex:'#c9a84c',name:'Gold/Champagne'},{hex:'#8b7355',name:'Brown/Chocolate'},{hex:'#7b3f3f',name:'Burgundy/Wine'},{hex:'#9e9e9e',name:'Silver/Grey'},{hex:'#4a7fa5',name:'Slate Blue'},{hex:'#2d5a3d',name:'Olive Green'},{hex:'#d4a5a5',name:'Pink/Rose'},{hex:'#f2f2f2',name:'Panda/White'}];
const BEZEL_COLORS=[{hex:'#1a1a1a',name:'Black'},{hex:'#2c3e6b',name:'Blue'},{hex:'#1e4d3b',name:'Green'},{hex:'#9e9e9e',name:'Steel/Silver'},{hex:'#c9a84c',name:'Gold'},{hex:'#e8c97a',name:'Yellow Gold'},{hex:'#c0c0c0',name:'White Gold'},{hex:'#b87333',name:'Rose Gold'},{hex:'#ff5722',name:'Red/Orange'},{hex:'#f5f0e8',name:'Ceramic White'},{hex:'#3d3d3d',name:'Dark Ceramic'},{hex:'#7b3f3f',name:'Burgundy'}];
function buildSwatches(cid,colors,fid){const el=document.getElementById(cid);if(!el)return;el.innerHTML=colors.map(c=>`<div class="color-chip" title="${c.name}" style="background:${c.hex}" onclick="selectColor('${cid}','${fid}','${c.name}',this)"></div>`).join('');}
function selectColor(cid,fid,name,el){document.querySelectorAll(`#${cid} .color-chip`).forEach(c=>c.classList.remove('selected'));el.classList.add('selected');document.getElementById(fid).value=name;}
function highlightSwatch(cid,name){document.querySelectorAll(`#${cid} .color-chip`).forEach(c=>{if(c.title===name)c.classList.add('selected');});}

// ‚îÄ‚îÄ PHOTO UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pendingPhotos=[],dragSrcIdx=null;

async function compressImage(dataUrl,maxWidth=1200,quality=0.82){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      let w=img.width,h=img.height;
      if(w>maxWidth){h=Math.round(h*maxWidth/w);w=maxWidth;}
      canvas.width=w;canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      resolve(canvas.toDataURL('image/jpeg',quality));
    };
    img.onerror=()=>resolve(dataUrl);
    img.src=dataUrl;
  });
}
async function dataUrlToBlob(dataUrl){const res=await fetch(dataUrl);return res.blob();}

function initPhotoListeners(){
  const zone=document.getElementById('photo-upload-zone');
  const input=document.getElementById('photo-file-input');
  const grid=document.getElementById('photo-preview-grid');
  zone.addEventListener('click',e=>{if(e.target.tagName==='BUTTON')return;input.click();});
  zone.addEventListener('dragover',e=>{e.preventDefault();zone.style.borderColor='var(--gold)';});
  zone.addEventListener('dragleave',()=>{zone.style.borderColor='var(--border2)';});
  zone.addEventListener('drop',e=>{
    e.preventDefault();zone.style.borderColor='var(--border2)';
    processPhotoFiles(Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/')));
  });
  input.addEventListener('change',e=>{processPhotoFiles(Array.from(e.target.files));e.target.value='';});
  grid.addEventListener('dragstart',e=>{if(e.target.closest('button')){e.preventDefault();return;}const t=e.target.closest('[data-idx]');if(!t)return;dragSrcIdx=parseInt(t.dataset.idx);setTimeout(()=>t.style.opacity='0.35',0);});
  grid.addEventListener('dragover',e=>{e.preventDefault();const t=e.target.closest('[data-idx]');if(!t)return;grid.querySelectorAll('[data-idx]').forEach(x=>x.style.outline='');if(parseInt(t.dataset.idx)!==dragSrcIdx)t.style.outline='2px solid var(--gold)';});
  grid.addEventListener('dragleave',e=>{const t=e.target.closest('[data-idx]');if(t)t.style.outline='';});
  grid.addEventListener('drop',e=>{e.preventDefault();const t=e.target.closest('[data-idx]');if(!t||dragSrcIdx===null)return;const dest=parseInt(t.dataset.idx);if(dest!==dragSrcIdx){const m=pendingPhotos.splice(dragSrcIdx,1)[0];pendingPhotos.splice(dest,0,m);}dragSrcIdx=null;renderPhotoGrid();});
  grid.addEventListener('dragend',()=>{dragSrcIdx=null;grid.querySelectorAll('[data-idx]').forEach(t=>{t.style.opacity='';t.style.outline='';});});
}
function processPhotoFiles(files){
  const remaining=8-pendingPhotos.length;
  files.slice(0,remaining).forEach(file=>{
    const ext=file.name.split('.').pop().toLowerCase();
    if(ext==='heic'||ext==='heif'){showToast('‚ö†Ô∏è HEIC not supported. iPhone: Settings ‚Üí Camera ‚Üí Formats ‚Üí Most Compatible.');return;}
    const reader=new FileReader();
    reader.onload=ev=>{pendingPhotos.push({file,url:ev.target.result,existing:false});renderPhotoGrid();};
    reader.readAsDataURL(file);
  });
}
function renderPhotoGrid(){
  const grid=document.getElementById('photo-preview-grid');
  const status=document.getElementById('photo-upload-status');
  if(!pendingPhotos.length){grid.innerHTML='';status.textContent='';return;}
  grid.innerHTML=pendingPhotos.map((p,i)=>`<div class="photo-thumb" draggable="true" data-idx="${i}"><img src="${p.url}" alt="Photo ${i+1}" style="pointer-events:none">${i===0?'<div class="photo-main-badge">Main</div>':''}<button class="photo-remove" draggable="false" onmousedown="removePhotoNow(event,${i})">‚úï</button></div>`).join('');
  status.textContent=`${pendingPhotos.length}/8 photos ¬∑ Drag to reorder ¬∑ First = storefront main image`;
}
function removePhoto(idx){pendingPhotos.splice(idx,1);renderPhotoGrid();}
function removePhotoNow(e,idx){e.stopPropagation();e.preventDefault();if(e.stopImmediatePropagation)e.stopImmediatePropagation();pendingPhotos.splice(idx,1);renderPhotoGrid();}
function loadPhotosForEdit(urls){pendingPhotos=(urls||[]).map(url=>({file:null,url,existing:true}));renderPhotoGrid();}

async function uploadPhotosForWatch(watchId){
  const urls=[];
  for(const p of pendingPhotos){
    if(p.existing){urls.push(p.url);continue;}
    try{
      const compressed=await compressImage(p.url);
      const blob=await dataUrlToBlob(compressed);
      const path=`${currentUser.id}/${watchId}/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
      const{error:upErr}=await db.storage.from('watch-photos').upload(path,blob,{contentType:'image/jpeg',upsert:true});
      if(upErr){showToast('Upload error: '+upErr.message);continue;}
      const{data:urlData}=db.storage.from('watch-photos').getPublicUrl(path);
      urls.push(urlData.publicUrl);
    }catch(err){console.error('Photo error:',err);}
  }
  return urls;
}

// ‚îÄ‚îÄ SOLD PHOTO MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let editingSoldId=null,soldPendingPhotos=[],soldDragSrcIdx=null;

function openSoldPhotoModal(id){
  const s=soldWatches.find(w=>w.id===id);if(!s)return;
  editingSoldId=id;
  document.getElementById('sold-photo-modal-title').textContent=`Photos ‚Äî ${s.brand} ${s.model}`;
  soldPendingPhotos=(s.photo_urls||[]).map(url=>({file:null,url,existing:true}));
  renderSoldPhotoGrid();
  document.getElementById('sold-photo-modal').classList.add('open');
}
function closeSoldPhotoModal(){document.getElementById('sold-photo-modal').classList.remove('open');editingSoldId=null;soldPendingPhotos=[];}
function renderSoldPhotoGrid(){
  const grid=document.getElementById('sold-photo-preview-grid');
  const status=document.getElementById('sold-photo-status');
  if(!soldPendingPhotos.length){
    grid.innerHTML='<div style="padding:1rem;text-align:center;font-size:0.75rem;color:var(--text2)">No photos ‚Äî add some above</div>';
    status.textContent='';return;
  }
  grid.innerHTML=soldPendingPhotos.map((p,i)=>`
    <div class="photo-thumb" draggable="true" data-sidx="${i}">
      <img src="${p.url}" alt="" style="pointer-events:none;width:100%;height:100%;object-fit:cover;display:block">
      ${i===0?'<div class="photo-main-badge">Main</div>':''}
      <button draggable="false" onmousedown="deleteSoldPhoto(event,${i})" style="position:absolute;top:3px;right:3px;background:rgba(200,0,0,0.9);color:#fff;border:none;width:22px;height:22px;border-radius:50%;font-size:0.8rem;cursor:pointer;font-weight:700;z-index:100;line-height:22px;text-align:center">‚úï</button>
    </div>`).join('');
  status.textContent=`${soldPendingPhotos.length}/8 ¬∑ Drag to reorder ¬∑ First = main`;
}
function deleteSoldPhoto(e,idx){
  e.stopPropagation();e.preventDefault();
  if(e.stopImmediatePropagation)e.stopImmediatePropagation();
  soldPendingPhotos.splice(idx,1);
  renderSoldPhotoGrid();
}

function initSoldPhotoListeners(){
  const zone=document.getElementById('sold-photo-upload-zone');
  const input=document.getElementById('sold-photo-file-input');
  const grid=document.getElementById('sold-photo-preview-grid');
  zone.addEventListener('click',()=>input.click());
  zone.addEventListener('dragover',e=>{e.preventDefault();zone.style.borderColor='var(--gold)';});
  zone.addEventListener('dragleave',()=>{zone.style.borderColor='var(--border2)';});
  zone.addEventListener('drop',e=>{
    e.preventDefault();zone.style.borderColor='var(--border2)';
    const files=Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/'));
    const rem=8-soldPendingPhotos.length;
    files.slice(0,rem).forEach(file=>{const r=new FileReader();r.onload=ev=>{soldPendingPhotos.push({file,url:ev.target.result,existing:false});renderSoldPhotoGrid();};r.readAsDataURL(file);});
  });
  input.addEventListener('change',e=>{
    const files=Array.from(e.target.files);
    const rem=8-soldPendingPhotos.length;
    files.slice(0,rem).forEach(file=>{
      const ext=file.name.split('.').pop().toLowerCase();
      if(ext==='heic'||ext==='heif'){showToast('‚ö†Ô∏è HEIC not supported.');return;}
      const r=new FileReader();r.onload=ev=>{soldPendingPhotos.push({file,url:ev.target.result,existing:false});renderSoldPhotoGrid();};r.readAsDataURL(file);
    });
    e.target.value='';
  });
  grid.addEventListener('dragstart',e=>{if(e.target.closest('button')){e.preventDefault();return;}const t=e.target.closest('[data-sidx]');if(!t)return;soldDragSrcIdx=parseInt(t.dataset.sidx);setTimeout(()=>t.style.opacity='0.35',0);});
  grid.addEventListener('dragover',e=>{e.preventDefault();const t=e.target.closest('[data-sidx]');if(!t)return;grid.querySelectorAll('[data-sidx]').forEach(x=>x.style.outline='');if(parseInt(t.dataset.sidx)!==soldDragSrcIdx)t.style.outline='2px solid var(--gold)';});
  grid.addEventListener('dragleave',e=>{const t=e.target.closest('[data-sidx]');if(t)t.style.outline='';});
  grid.addEventListener('drop',e=>{e.preventDefault();const t=e.target.closest('[data-sidx]');if(!t||soldDragSrcIdx===null)return;const dest=parseInt(t.dataset.sidx);if(dest!==soldDragSrcIdx){const m=soldPendingPhotos.splice(soldDragSrcIdx,1)[0];soldPendingPhotos.splice(dest,0,m);}soldDragSrcIdx=null;renderSoldPhotoGrid();});
  grid.addEventListener('dragend',()=>{soldDragSrcIdx=null;grid.querySelectorAll('[data-sidx]').forEach(t=>{t.style.opacity='';t.style.outline='';});});
}

async function saveSoldPhotos(){
  if(!editingSoldId)return;
  const btn=document.getElementById('sold-photo-save-btn');
  btn.disabled=true;btn.textContent=soldPendingPhotos.some(p=>!p.existing)?'Uploading...':'Saving...';
  const urls=[];
  for(const p of soldPendingPhotos){
    if(p.existing){urls.push(p.url);continue;}
    try{
      const compressed=await compressImage(p.url);
      const blob=await dataUrlToBlob(compressed);
      const path=`${currentUser.id}/sold/${editingSoldId}/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
      const{error:upErr}=await db.storage.from('watch-photos').upload(path,blob,{contentType:'image/jpeg',upsert:true});
      if(upErr){showToast('Upload error: '+upErr.message);continue;}
      const{data:urlData}=db.storage.from('watch-photos').getPublicUrl(path);
      urls.push(urlData.publicUrl);
    }catch(err){console.error(err);}
  }
  const{error}=await db.from('sold_inventory').update({photo_urls:urls}).eq('id',editingSoldId);
  if(error){showToast('Error: '+error.message);btn.disabled=false;btn.textContent='Save Photos';return;}
  const idx=soldWatches.findIndex(w=>w.id===editingSoldId);
  if(idx!==-1)soldWatches[idx].photo_urls=urls;
  btn.disabled=false;btn.textContent='Save Photos';
  closeSoldPhotoModal();renderSold();showToast('Photos saved.');
}

// ‚îÄ‚îÄ IMPORT / EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleDrop(e,type){e.preventDefault();document.getElementById('drop-'+type).classList.remove('drag');const file=e.dataTransfer.files[0];if(file)parseCSV(file,type);}
function handleFileInput(e,type){const file=e.target.files[0];if(file)parseCSV(file,type);}

function parseCSV(file,type){
  const reader=new FileReader();
  reader.onload=e=>{
    const lines=e.target.result.split('\n').filter(l=>l.trim());
    if(lines.length<2){showToast('CSV must have a header row and at least one data row.');return;}
    const headers=lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));
    const rows=lines.slice(1).map(line=>{
      const vals=line.split(',');
      const obj={};
      headers.forEach((h,i)=>obj[h]=(vals[i]||'').trim().replace(/^"|"$/g,''));
      return obj;
    }).filter(r=>r.brand&&r.model);
    showImportPreview(rows,type);
  };
  reader.readAsText(file);
}

function showImportPreview(rows,type){
  const preview=document.getElementById('import-preview');
  preview.style.display='block';
  preview.innerHTML=`
    <div class="panel">
      <div class="panel-title">Import Preview ‚Äî ${rows.length} rows (${type})</div>
      <p style="font-size:0.75rem;color:var(--text2);margin-bottom:1rem">Review the data below, then click Import to add to your account.</p>
      <div style="overflow-x:auto;max-height:300px;overflow-y:auto">
        <table class="mini-table">
          <thead><tr><th>Brand</th><th>Model</th><th>Ref</th><th>Purchase Price</th>${type==='sold'?'<th>Sold Price</th>':''}</tr></thead>
          <tbody>${rows.slice(0,20).map(r=>`<tr><td>${r.brand}</td><td>${r.model}</td><td>${r.ref||'‚Äî'}</td><td>${r.purchase_price?'$'+r.purchase_price:'‚Äî'}</td>${type==='sold'?`<td>${r.sold_price?'$'+r.sold_price:'‚Äî'}</td>`:''}</tr>`).join('')}</tbody>
        </table>
        ${rows.length>20?`<p style="font-size:0.7rem;color:var(--text2);margin-top:0.5rem">...and ${rows.length-20} more rows</p>`:''}
      </div>
      <div style="margin-top:1rem;display:flex;gap:0.5rem">
        <button class="btn-gold" onclick="confirmImport(window._importRows,window._importType)">Import ${rows.length} Watches</button>
        <button class="btn-outline" onclick="document.getElementById('import-preview').style.display='none'">Cancel</button>
      </div>
    </div>`;
  window._importRows=rows;window._importType=type;
}

async function confirmImport(rows,type){
  const table=type==='sold'?'sold_inventory':'inventory';
  const dbRows=rows.map(r=>{
    const base={user_id:currentUser.id,brand:r.brand,model:r.model,ref:r.ref||null,serial:r.serial||null,year:r.year||null,purchase_date:r.purchase_date||null,purchase_price:parseFloat(r.purchase_price)||0,tax:parseFloat(r.tax)||0,shipping_in:parseFloat(r.shipping_in)||0,other_fees:parseFloat(r.other_fees)||0,notes:r.notes||null,condition:r.condition||null,box_papers:r.box_papers||null,platform:r.platform||null};
    if(type==='sold')return{...base,sale_date:r.sale_date||null,sold_price:parseFloat(r.sold_price)||0,platform_fee:parseFloat(r.platform_fee)||0,payment_fee:parseFloat(r.payment_fee)||0,shipping_out:parseFloat(r.shipping_out)||0};
    return{...base,listed_price:parseFloat(r.listed_price)||null};
  });
  const{error}=await db.from(table).insert(dbRows);
  if(error){showToast('Import error: '+error.message);return;}
  await loadAllData();refreshAll();
  document.getElementById('import-preview').style.display='none';
  showToast(`Imported ${rows.length} watches.`);
}

function downloadTemplate(type){
  const inv='brand,model,ref,serial,year,purchase_date,purchase_price,tax,shipping_in,other_fees,listed_price,platform,condition,box_papers,notes\nRolex,Submariner,126610LN,ABC123,2022,2024-01-15,12500,0,45,0,14500,Direct,Excellent (8/10),Full Set (Box + Papers),Great condition';
  const sold='brand,model,ref,serial,year,purchase_date,purchase_price,tax,shipping_in,other_fees,sale_date,sold_price,platform_fee,payment_fee,shipping_out,platform,notes\nOmega,Seamaster,210.30.42,XYZ789,2020,2023-06-01,3800,0,30,0,2024-01-20,4600,46,0,25,eBay,Quick sale';
  const csv=type==='sold'?sold:inv;
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download=`dialtrader-${type}-template.csv`;a.click();
}

function exportInventoryCSV(){
  if(!inventory.length){showToast('No inventory to export.');return;}
  const headers=['brand','model','ref','serial','year','purchase_date','purchase_price','tax','shipping_in','other_fees','listed_price','platform','condition','box_papers','notes'];
  const rows=inventory.map(w=>headers.map(h=>`"${(w[h]||'').toString().replace(/"/g,'""')}"`).join(','));
  const csv=[headers.join(','),...rows].join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download=`dialtrader-inventory-${new Date().toISOString().split('T')[0]}.csv`;a.click();
}

// ‚îÄ‚îÄ UNSELL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function unsellWatch(id){
  const s=soldWatches.find(w=>w.id===id);if(!s)return;
  if(!confirm(`Move "${s.brand} ${s.model}" back to inventory? All sale data will be cleared.`))return;
  const invRow={
    user_id:currentUser.id,brand:s.brand,model:s.model,ref:s.ref,serial:s.serial,year:s.year,
    purchase_date:s.purchase_date,purchase_price:s.purchase_price,tax:s.tax,
    shipping_in:s.shipping_in,other_fees:s.other_fees,
    listed_price:null,msrp:s.msrp||null,platform:s.platform||null,
    notes:s.notes,condition:s.condition,box_papers:s.box_papers,
    case_size:s.case_size,case_material:s.case_material,movement:s.movement,
    dial_color:s.dial_color,bezel_color:s.bezel_color,bracelet_type:s.bracelet_type,bracelet_color:s.bracelet_color,
    buy_name:s.buy_name,buy_phone:s.buy_phone,buy_email:s.buy_email,buy_location:s.buy_location,
    sell_name:null,sell_phone:null,sell_email:null,sell_location:null,
    contact_id:s.contact_id||null,
    photo_urls:s.photo_urls||[],
  };
  const[ins,del]=await Promise.all([
    db.from('inventory').insert(invRow).select().single(),
    db.from('sold_inventory').delete().eq('id',id)
  ]);
  if(ins.error){showToast('Error: '+ins.error.message);return;}
  inventory.unshift(ins.data);
  soldWatches=soldWatches.filter(w=>w.id!==id);
  refreshAll();showToast(`${s.brand} ${s.model} moved back to inventory.`);
}

// ‚îÄ‚îÄ TAX REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTaxReport(){
  if(!soldWatches.length){
    document.getElementById('tax-report-content').innerHTML='<div class="empty-state"><h3>No sold watches yet</h3><p>Tax report will appear here once you have sold watches.</p></div>';
    return;
  }
  // Populate year filter
  const years=[...new Set(soldWatches.map(s=>s.sale_date?new Date(s.sale_date).getFullYear():null).filter(Boolean))].sort((a,b)=>b-a);
  const sel=document.getElementById('tax-year-filter');
  const cur=sel.value;
  sel.innerHTML='<option value="all">All Years</option>'+years.map(y=>`<option value="${y}">${y}</option>`).join('');
  if(cur)sel.value=cur;

  const filterYear=sel.value;
  const filtered=filterYear==='all'?soldWatches:soldWatches.filter(s=>s.sale_date&&new Date(s.sale_date).getFullYear()==filterYear);
  const yearsToShow=filterYear==='all'?years:[parseInt(filterYear)];

  const html=yearsToShow.map(year=>{
    const yw=filtered.filter(s=>s.sale_date&&new Date(s.sale_date).getFullYear()===year);
    if(!yw.length)return'';
    const grossSales=yw.reduce((s,w)=>s+(+w.sold_price||0),0);
    const totalCOGS=yw.reduce((s,w)=>s+soldCostBasis(w),0);
    const totalFees=yw.reduce((s,w)=>s+(+w.platform_fee||0)+(+w.payment_fee||0)+(+w.shipping_out||0),0);
    const netProfit=yw.reduce((s,w)=>s+soldNetProfit(w),0);
    return`<div class="tax-year-block">
      <div class="tax-year-header">
        <div class="tax-year-title">${year} Tax Year</div>
        <div class="tax-year-net ${netProfit>=0?'pos':'neg'}">${fmt(netProfit)}</div>
      </div>
      <div class="tax-summary-grid">
        <div class="tax-summary-cell"><div class="tax-summary-label">Gross Sales</div><div class="tax-summary-val">${fmt(grossSales)}</div></div>
        <div class="tax-summary-cell"><div class="tax-summary-label">Cost of Goods Sold</div><div class="tax-summary-val">${fmt(totalCOGS)}</div></div>
        <div class="tax-summary-cell"><div class="tax-summary-label">Platform &amp; Sell Fees</div><div class="tax-summary-val">${fmt(totalFees)}</div></div>
        <div class="tax-summary-cell"><div class="tax-summary-label">Net Profit</div><div class="tax-summary-val" style="color:${netProfit>=0?'var(--green)':'var(--red)'}">${fmt(netProfit)}</div></div>
      </div>
      <div class="tax-transactions">
        <table>
          <thead><tr><th>Sale Date</th><th>Watch</th><th>Ref / Serial</th><th>Cost Basis</th><th>Sold Price</th><th>Fees</th><th>Net Profit</th><th>ROI</th><th>Platform</th></tr></thead>
          <tbody>
            ${yw.map(s=>{
              const p=soldNetProfit(s),r=soldROI(s);
              const fees=(+s.platform_fee||0)+(+s.payment_fee||0)+(+s.shipping_out||0);
              const plat=Array.isArray(s.platform)?s.platform.join(', '):(s.platform||'‚Äî');
              return`<tr>
                <td style="white-space:nowrap">${s.sale_date||'‚Äî'}</td>
                <td><strong>${s.brand}</strong> ${s.model}</td>
                <td style="color:var(--text2)">${[s.ref,s.serial?'SN:'+s.serial:''].filter(Boolean).join(' ¬∑ ')||'‚Äî'}</td>
                <td>${fmt(soldCostBasis(s))}</td>
                <td>${fmt(s.sold_price)}</td>
                <td style="color:var(--text2)">${fmt(fees)}</td>
                <td style="color:${p>=0?'var(--green)':'var(--red)'}"><strong>${p>=0?'+':''}${fmt(p)}</strong></td>
                <td style="color:${r>=0?'var(--green)':'var(--red)'}">${fmtPct(r)}</td>
                <td style="font-size:0.68rem;color:var(--text2)">${plat}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>`;
  }).join('');
  document.getElementById('tax-report-content').innerHTML=html||'<div class="empty-state"><p>No data for selected year.</p></div>';
}

function exportTaxCSV(){
  const filterYear=document.getElementById('tax-year-filter').value;
  const f=filterYear==='all'?soldWatches:soldWatches.filter(s=>s.sale_date&&new Date(s.sale_date).getFullYear()==filterYear);
  if(!f.length){showToast('No data to export.');return;}
  const headers=['sale_date','brand','model','ref','serial','purchase_date','cost_basis','sold_price','platform_fee','payment_fee','shipping_out','net_profit','roi_pct','platform'];
  const rows=f.map(s=>{
    const p=soldNetProfit(s),r=soldROI(s);
    const plat=Array.isArray(s.platform)?s.platform.join('|'):(s.platform||'');
    return[s.sale_date||'',s.brand||'',s.model||'',s.ref||'',s.serial||'',s.purchase_date||'',soldCostBasis(s).toFixed(2),(+s.sold_price||0).toFixed(2),(+s.platform_fee||0).toFixed(2),(+s.payment_fee||0).toFixed(2),(+s.shipping_out||0).toFixed(2),p.toFixed(2),r.toFixed(2),plat].map(v=>`"${v}"`).join(',');
  });
  const csv=[headers.join(','),...rows].join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download=`dialtrader-tax-${filterYear}-${new Date().toISOString().split('T')[0]}.csv`;a.click();
}

// ‚îÄ‚îÄ INVOICE TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentInvoiceTab='sent';
function switchInvoiceTab(tab){
  currentInvoiceTab=tab;
  const sentBtn=document.getElementById('tab-sent-btn');
  const recBtn=document.getElementById('tab-received-btn');
  const sentPanel=document.getElementById('sent-invoices-panel');
  const recPanel=document.getElementById('received-invoices-panel');
  const newBtn=document.getElementById('new-invoice-btn');
  const upBtn=document.getElementById('upload-invoice-btn');
  if(tab==='sent'){
    sentBtn.style.background='var(--charcoal)';sentBtn.style.color='#fff';
    recBtn.style.background='';recBtn.style.color='var(--text2)';
    sentPanel.style.display='';recPanel.style.display='none';
    newBtn.style.display='';upBtn.style.display='none';
  } else {
    recBtn.style.background='var(--charcoal)';recBtn.style.color='#fff';
    sentBtn.style.background='';sentBtn.style.color='var(--text2)';
    recPanel.style.display='';sentPanel.style.display='none';
    newBtn.style.display='none';upBtn.style.display='';
    renderReceivedInvoices();
  }
}

// ‚îÄ‚îÄ RECEIVED INVOICES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let receivedInvoices=[],editingReceivedId=null,riFile=null,riFileDataUrl=null;

async function loadReceivedInvoices(){
  const{data}=await db.from('received_invoices').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false});
  receivedInvoices=data||[];
}

function renderReceivedInvoices(){
  const list=document.getElementById('received-invoice-list');
  const empty=document.getElementById('received-empty');
  if(!receivedInvoices.length){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  list.innerHTML=receivedInvoices.map(inv=>{
    // Find linked watch
    const w=inv.watch_id?inventory.find(x=>x.id===inv.watch_id)||soldWatches.find(x=>x.id===inv.watch_id):null;
    return`<div class="invoice-item" onclick="viewReceivedInvoice('${inv.id}')">
      <div class="invoice-num" style="color:var(--text2)">üì•</div>
      <div>
        <div class="invoice-client">${inv.seller_name||'Unknown Seller'}</div>
        <div class="invoice-desc">${inv.invoice_date||''}${w?' ¬∑ '+w.brand+' '+w.model:''}</div>
      </div>
      <div></div>
      <div class="invoice-amount">${inv.amount?fmt(inv.amount):'‚Äî'}</div>
      <div style="display:flex;gap:0.4rem;align-items:center">
        ${inv.file_url?`<span style="font-size:0.7rem;color:var(--blue)">üìé File</span>`:''}
        <button class="btn-outline btn-sm" onclick="event.stopPropagation();openReceivedModal('${inv.id}')">Edit</button>
      </div>
    </div>`;
  }).join('');
}

function openReceivedModal(id){
  editingReceivedId=id||null;riFile=null;riFileDataUrl=null;
  document.getElementById('received-modal-title').textContent=id?'Edit Received Invoice':'Upload Received Invoice';
  document.getElementById('ri-delete-btn').style.display=id?'inline-block':'none';
  document.getElementById('ri-file-preview').style.display='none';
  document.getElementById('ri-upload-label').textContent='Drop PDF or image here, or click to browse';
  // Populate watch dropdown
  const allWatches=[...inventory.map(w=>({id:w.id,label:`[Inventory] ${w.brand} ${w.model}${w.ref?' '+w.ref:''}`})),...soldWatches.map(w=>({id:w.id,label:`[Sold] ${w.brand} ${w.model}${w.ref?' '+w.ref:''}`}))];
  document.getElementById('ri-watch-link').innerHTML='<option value="">‚Äî None ‚Äî</option>'+allWatches.map(w=>`<option value="${w.id}">${w.label}</option>`).join('');
  if(id){
    const inv=receivedInvoices.find(x=>x.id===id);if(!inv)return;
    document.getElementById('ri-seller').value=inv.seller_name||'';
    document.getElementById('ri-date').value=inv.invoice_date||'';
    document.getElementById('ri-amount').value=inv.amount||'';
    document.getElementById('ri-notes').value=inv.notes||'';
    document.getElementById('ri-watch-link').value=inv.watch_id||'';
    if(inv.file_url){document.getElementById('ri-upload-label').textContent='Current file attached ‚Äî upload new to replace';}
  } else {
    ['ri-seller','ri-date','ri-amount','ri-notes'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('ri-watch-link').value='';
    document.getElementById('ri-date').value=new Date().toISOString().split('T')[0];
  }
  document.getElementById('received-modal').classList.add('open');
}
function closeReceivedModal(){document.getElementById('received-modal').classList.remove('open');}

function handleRiDrop(e){
  e.preventDefault();document.getElementById('ri-upload-zone').style.borderColor='';
  const file=e.dataTransfer.files[0];if(file)setRiFile(file);
}
function handleRiFile(e){const file=e.target.files[0];if(file)setRiFile(file);e.target.value='';}
function setRiFile(file){
  riFile=file;
  const reader=new FileReader();
  reader.onload=ev=>{
    riFileDataUrl=ev.target.result;
    document.getElementById('ri-file-name').textContent=file.name;
    document.getElementById('ri-file-size').textContent=(file.size/1024).toFixed(0)+' KB';
    document.getElementById('ri-file-preview').style.display='block';
    document.getElementById('ri-upload-label').textContent='File ready ‚Äî '+file.name;
  };
  reader.readAsDataURL(file);
}
function clearRiFile(){riFile=null;riFileDataUrl=null;document.getElementById('ri-file-preview').style.display='none';document.getElementById('ri-upload-label').textContent='Drop PDF or image here, or click to browse';}

async function saveReceivedInvoice(){
  const seller=document.getElementById('ri-seller').value.trim();
  if(!seller){showToast('Seller name is required.');return;}
  let fileUrl=editingReceivedId?(receivedInvoices.find(x=>x.id===editingReceivedId)||{}).file_url||null:null;
  if(riFile&&riFileDataUrl){
    const blob=await(await fetch(riFileDataUrl)).blob();
    const ext=riFile.name.split('.').pop();
    const path=`${currentUser.id}/received/${Date.now()}.${ext}`;
    const{error:upErr}=await db.storage.from('watch-photos').upload(path,blob,{contentType:riFile.type,upsert:true});
    if(upErr){showToast('Upload error: '+upErr.message);return;}
    const{data:urlData}=db.storage.from('watch-photos').getPublicUrl(path);
    fileUrl=urlData.publicUrl;
  }
  const row={user_id:currentUser.id,seller_name:seller,invoice_date:document.getElementById('ri-date').value||null,amount:parseFloat(document.getElementById('ri-amount').value)||null,notes:document.getElementById('ri-notes').value.trim()||null,watch_id:document.getElementById('ri-watch-link').value||null,file_url:fileUrl};
  if(editingReceivedId){
    const{error}=await db.from('received_invoices').update(row).eq('id',editingReceivedId);
    if(error){showToast('Error: '+error.message);return;}
    receivedInvoices=receivedInvoices.map(i=>i.id===editingReceivedId?{...i,...row,id:editingReceivedId}:i);
  } else {
    const{data,error}=await db.from('received_invoices').insert(row).select().single();
    if(error){showToast('Error: '+error.message);return;}
    receivedInvoices.unshift(data);
  }
  closeReceivedModal();renderReceivedInvoices();showToast('Invoice saved.');
}

async function deleteReceivedInvoice(){
  if(!editingReceivedId||!confirm('Delete this received invoice?'))return;
  const{error}=await db.from('received_invoices').delete().eq('id',editingReceivedId);
  if(error){showToast('Error: '+error.message);return;}
  receivedInvoices=receivedInvoices.filter(i=>i.id!==editingReceivedId);
  closeReceivedModal();renderReceivedInvoices();showToast('Invoice deleted.');
}

function viewReceivedInvoice(id){
  const inv=receivedInvoices.find(x=>x.id===id);if(!inv)return;
  if(inv.file_url){window.open(inv.file_url,'_blank');}
  else{openReceivedModal(id);}
}

// ‚îÄ‚îÄ SOLD EDIT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let editingSoldWatchId=null;

function switchSoldTab(tab){
  document.querySelectorAll('#sold-edit-modal .modal-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#sold-edit-modal .modal-tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelector(`#sold-edit-modal .modal-tab[onclick="switchSoldTab('${tab}')"]`).classList.add('active');
  document.getElementById('tab-'+tab).classList.add('active');
}

function openSoldEditModal(id){
  const s=soldWatches.find(w=>w.id===id);if(!s)return;
  editingSoldWatchId=id;
  document.getElementById('sold-edit-title').textContent=`Edit: ${s.brand} ${s.model}`;
  // Sale Details
  const fields={
    'se-sale-date':s.sale_date,'se-sold-price':s.sold_price,'se-platform-fee':s.platform_fee,
    'se-payment-fee':s.payment_fee,'se-shipping-out':s.shipping_out,
    'se-purchase-date':s.purchase_date,'se-purchase-price':s.purchase_price,
    'se-tax':s.tax,'se-shipping-in':s.shipping_in,'se-other-fees':s.other_fees,'se-notes':s.notes,
    // Watch info
    'se-brand':s.brand,'se-model':s.model,'se-ref':s.ref,'se-serial':s.serial,
    'se-year':s.year,'se-case-size':s.case_size,'se-dial-color':s.dial_color,
    // Contacts
    'se-buy-name':s.buy_name,'se-buy-phone':s.buy_phone,'se-buy-email':s.buy_email,
    'se-sell-name':s.sell_name,'se-sell-phone':s.sell_phone,'se-sell-email':s.sell_email,
  };
  Object.entries(fields).forEach(([fid,val])=>{const el=document.getElementById(fid);if(el)el.value=val||'';});
  document.getElementById('se-condition').value=s.condition||'';
  document.getElementById('se-box-papers').value=s.box_papers||'';
  setPlatforms('se-platform-checks',s.platform||[]);
  switchSoldTab('se-basics');
  document.getElementById('sold-edit-modal').classList.add('open');
}
function closeSoldEditModal(){document.getElementById('sold-edit-modal').classList.remove('open');editingSoldWatchId=null;}

async function saveSoldEdit(){
  if(!editingSoldWatchId)return;
  const g=id=>(document.getElementById(id).value||'').trim();
  const row={
    sale_date:g('se-sale-date')||null,
    sold_price:parseFloat(g('se-sold-price'))||0,
    platform_fee:parseFloat(g('se-platform-fee'))||0,
    payment_fee:parseFloat(g('se-payment-fee'))||0,
    shipping_out:parseFloat(g('se-shipping-out'))||0,
    purchase_date:g('se-purchase-date')||null,
    purchase_price:parseFloat(g('se-purchase-price'))||0,
    tax:parseFloat(g('se-tax'))||0,
    shipping_in:parseFloat(g('se-shipping-in'))||0,
    other_fees:parseFloat(g('se-other-fees'))||0,
    notes:g('se-notes')||null,
    brand:g('se-brand'),model:g('se-model'),ref:g('se-ref')||null,serial:g('se-serial')||null,
    year:g('se-year')||null,case_size:g('se-case-size')||null,dial_color:g('se-dial-color')||null,
    condition:document.getElementById('se-condition').value||null,
    box_papers:document.getElementById('se-box-papers').value||null,
    platform:getPlatforms('se-platform-checks'),
    buy_name:g('se-buy-name')||null,buy_phone:g('se-buy-phone')||null,buy_email:g('se-buy-email')||null,
    sell_name:g('se-sell-name')||null,sell_phone:g('se-sell-phone')||null,sell_email:g('se-sell-email')||null,
  };
  const{error}=await db.from('sold_inventory').update(row).eq('id',editingSoldWatchId);
  if(error){showToast('Error: '+error.message);return;}
  soldWatches=soldWatches.map(w=>w.id===editingSoldWatchId?{...w,...row,id:editingSoldWatchId}:w);
  closeSoldEditModal();renderSold();renderDashboard();showToast('Sold watch updated.');
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',()=>{
  initAuth();
  initPhotoListeners();
  initSoldPhotoListeners();
  // Inject logo into sidebar - above text, fills sidebar width
  const sidebarIcon=document.getElementById('sidebar-logo-icon');
  if(sidebarIcon&&typeof LOGO_SVG!=='undefined'){
    // Size to fit sidebar (210px wide, keep aspect ratio 600:700 = 0.857)
    // At width 160px, height = 160*(700/600) = 186px ‚Äî fits well
    const sized=LOGO_SVG
      .replace(/width="600"/, 'width="160"')
      .replace(/height="700"/, 'height="187"');
    sidebarIcon.innerHTML=sized;
  }
});
</script>
</body>
</html>
